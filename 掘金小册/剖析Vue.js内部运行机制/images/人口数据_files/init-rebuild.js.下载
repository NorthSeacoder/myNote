/**
 * 地图相关参数
 */
var gMap = null;
/**
 * 公共参数js
 */
var index = 0; //初始化默认为人口规模页面
var isChange = true; //指标选择是否改变参数
var isFinish = false; //dom是否渲染完成
/**
 * 地图相关参数区
 */
var cityMapControlType = []; //指标配置类型
var struTypes = [];
var mapData; //地图接口接收参数
var netMapData; //网格地图接口接收参数
var polygonMapUid; //面图uid参数
var polygonMapObj; //面图对象
//网格
var netMapUid; //面图uid参数
var netMapObj; //面图对象
var dimenHasData = false;
var heartType = [];
var pointMapUid; //点图uid
var pointMapObj; //点图obj
/**
 * 地图对象
 */
var mapConfigObj = {
	"polygonMapId": "", //面图(版块图)
	"pointMapId": "", //点图(热力图等)
	"odMapId": "", //od图
	"ifclick": true, //是否存在单击事件
	"odTypes": "",
	"heartType": "",
	"labelField": ""
};
/**
 * od图参数
 */
var odViz;
var odStates = false;
var loc = [];
var odColor = [];
var odStates = false;
var odData = [];
var tar = [];
var odobj;
var nice_scroll_classobj = {
	styler: "fb",
	cursorcolor: "#bdbec7",
	cursorwidth: '8',
	cursorborderradius: '10px',
	background: '#fff',
	spacebarenabled: false,
	autohidemode: 'leave',
	cursorborder: '0',
	zindex: '1000'
}
/**
 * 人口规模对象
 */
var sizeObj = {
	"analysisType": 0, //0.人口规模 1.职住迁徙
	"boardId": null, //版块id，街道id,区县id
	"boardName": null, //版块名称，街道名称，区县名称
	"cityId": cityId, //城市id
	"cityName": cityName, //城市名称
	"crowd": 1, //0.居住人群 1.工作人群
	"indexName": "0", //0.密度 1.人口 2.职住比
	"ownerId": "standard", //所有者
	"type": "board", //区域类型，版块，区县，街道
	"selectArea": null //区域选择，null表示所有区域全选
};

/**
 * 职住迁徙对象
 */
var struObj = {
	"analysisType": 1, //0.人口规模 1.职住迁徙
	"boardId": null, //版块id，街道id,区县id
	"boardName": null, //版块名称，街道名称，区县名称
	"cityId": cityId, //城市id
	"cityName": cityName, //城市名称
	"crowd": 1, //0.居住人群 1.工作人群
	"indexName": "0", //职住迁徙不需要这个参数
	"ownerId": "standard", //所有者
	"type": "board", //区域类型，版块，区县，街道
	"selectArea": null //区域选择，null表示所有区域全选
};
var dimenConfig = {
	board: '板块',
	street: '街道'
}
var netUnit;
G.ready(function () {
	/**
	 * 1.1构建地图
	 */
	G.loadModules(['heat', 'maps', 'fluid', 'dataviz', 'anim', 'draw'], function () {
		gMap = new cityGMap.gmap({
			map: 'map',
			city: cityName,
			zoom: 10
		});
		/**
		 * 1.2设置地图样式
		 */
		gMap.setMapType(cityGMap.mapType.GeoHey, cityGMap.mapStyle.light);

		//设置中心和缩放级别
		if (cityName == "长春") {
			gMap.setCenterAndZoom(cityName, 9);
		}

		/**
		 * 1.3 切换地图
		 */
		mapConfig.setMap([gMap]);


		/**
		 * 1.初始化切换选择条件和页面相关显示问题
		 */
		init(index, mapConfigObj);
		//网格
		$(document).on('click', '.grid-box .btn-switch', function () {
			//	$('.grid-box .btn-switch').toggleClass('is-checked');
			//	$('.modal-bggray').toggle();
			if (!$('.grid-box .btn-switch').hasClass('is-disabled')) {
				if (!$('.grid-box .btn-switch').hasClass('is-checked')) {
					//打开弹窗
					//$('.modal-bggray').toggle();
					//组装网格参数
					$('.grid-box .btn-switch').toggleClass('is-checked');
					sizeObj.dimensionType = dimenConfig[sizeObj.type];
					sizeObj.dimensionIds = sizeObj.selectArea
					console.log(sizeObj);
					dimen(sizeObj);
					dimenHasData = true;
					netMapObj = $("#populationSize").GetCityMapControl("mapVisualization").getLayer('netEffect');
					if (netMapObj) {
						netMapObj._show();
					}
				} else {
					$('.grid-box .btn-switch').toggleClass('is-checked');
					//关闭网格
					if (netMapObj) {
						netMapObj._hide();
						//图例
						$('#netName').parent().hide();
						$('#netMapLegend').hide()
					}
				}
			}


		});
		//确定
		// $(document).on('click', '.but_confirm', function () {
		// 	//关闭弹窗
		// 	$('.modal-bggray').toggle();
		// 	//右移
		// 	$('.grid-box .btn-switch').toggleClass('is-checked');
		// 	//组装网格参数
		// 	sizeObj.dimensionType = dimenConfig[sizeObj.type];
		// 	sizeObj.dimensionIds = sizeObj.selectArea
		// 	console.log(sizeObj);
		// 	dimen(sizeObj)


		// });
		//取消
		// $(document).on('click', '.but_cancel', function () {
		// 	//关闭弹窗
		// 	$('.modal-bggray').toggle();
		// });
		//x
		// $(document).on('click', '.modal-header .close', function () {
		// 	//关闭弹窗

		// 	$('.modal-bggray').toggle();
		// });
		//图例
		$(document).on('click', '.legendbox i', function (e) {
			//箭头朝向
			$(e.toElement).toggleClass('icon-arrow-down').toggleClass('icon-arrow-up');
			//console.log($(e.toElement).parent().next());
			//色块显隐
			$(e.toElement).parent().next().toggle();

		})
		/**
		 * 切换人口规模与职住迁徙后，初始化相应的页面
		 */
		$("#changeMenuPeople ul li a").click(function () {
			if (isFinish) {
				$(this).parent().addClass("on").siblings().removeClass("on"); //切换选中的按钮高亮状态
				index = $(this).parent().index(); //获取被按下按钮的索引值，需要注意index是从0开始的
				$(".tab_box >div").eq(index).show().siblings().hide(); //在按钮选中时在下面显示相应的内容，同时隐藏不需要的框架内容
				$(".tab_box_right>div").eq(index).show().siblings().hide();
				//应用切换
				$('.butbox >a').eq(index).show().siblings().hide();
				//obj.analysisType = index;
				$("#hideRight").removeAttr('id');
				$("#rightModule").removeAttr('id');
				/**
				 * 2.点击后，切换相应的查询条件
				 */
				isFinish = false;
				//网格禁用
				if (index == 1) {
					closeNet();
					$('.grid-box .btn-switch').addClass('is-disabled');
					$('#netSize').html('');
					dimenHasData = true; //禁止迁徙条件下发请求
				} else {

					$('.grid-box .btn-switch').removeClass('is-disabled')
				}
				init(index, mapConfigObj);
			}



		});

		/**
		 * 人口规模点击应用事件
		 *
		 */
		$(document).on('click', '#request-but-size', function () {
			/**
			 * 1.获取参数前调整样式
			 */
			//清除网格
			//closeNet();
			//dimenHasData = false;
			//panelDataViz[1].show = false;
			//点击应用取消弹窗
			if (netMapUid) {
				gMap.removeDataViz(netMapUid);
			}
			removeTip();
			$('.panel-body').css('display', 'block');
			/**
			 * 1.参数准备
			 */
			//人口规模-区域选择
			var districtArea = $('#districtAreaSelect').GetCityMapControl('districtAreaStd').val();
			if (districtArea.data && districtArea.data.length == 0) { //未选择区域的处理
				$("#districtAreaSelect div span[name='checkalldistrict'] ").click();
				districtArea = $('#districtAreaSelect').GetCityMapControl('districtAreaStd').val(); //重新过去数据
			}
			var selectArea = $.map(districtArea.data, function (item) {
				return [parseInt(item.id)]
			});
			//人口规模-数据选择
			var parameter = {};
			parameter = $.extend(true, {}, $('#peopleIndex').getParameter());
			//人口规模-指标选择
			var p = $.extend(true, {}, $('#dataIndex').getParameter());
			dataIndex = p.dataIndex ? p.dataIndex : '0';
			/**
			 * 2.获取参数后，调整样式调整|| sizeObj.indexName != dataIndex
			 */
			sizeObj.dimensionType = dimenConfig[districtArea.dimensionType];
			sizeObj.dimensionIds = selectArea
			if (!dimenHasData) {
				console.log(sizeObj);
				$('#netSize').html('');
				if ($('.grid-box .btn-switch').hasClass('is-checked')) {
					dimen(sizeObj);
				}
			} else if ($('.grid-box .btn-switch').hasClass('is-checked')) {
				if (sizeObj.crowd != parameter.peopleIndex) {
					// var newIndex = getPeopleIndex(parseInt(parameter.peopleIndex), parseInt(dataIndex));
					// if ($("#netSize").GetCityMapControl("mapVisualization")) {
					// 	var selectIndex_net = $("#netSize").GetCityMapControl("mapVisualization").getLayer("netEffect");
					// 	$('#netEffect').find('div[data-box=sectionIndex]').find('.citymapControl-select-title').click();
					// 	$('#netEffect').find('div[data-box=sectionIndex]').find('.citymapControl-select-title').click();
					// 	selectIndex_net.setGrid({
					// 		fieldName: newIndex
					// 	})
					// }
					if ($('.grid-box .btn-switch').hasClass('is-checked')) {
						dimen(sizeObj);

					}
				} else {
					var ids = sizeObj.dimensionIds.join("','");
					//获取选择区域sizeObj.type +
					var betArea = $('#districtAreaSelect').GetCityMapControl('districtAreaStd').val();
					if (!betArea.isall) {
						panelDataViz[1].filter = districtArea.dimensionType + "_id in ('" + ids + "')"
						//panelDataViz[1].filter = "street_id in ('" + ids + "')"
						//panelDataViz[1].filter = "street_id in ('33892')"
					} else {
						panelDataViz[1].filter = ""
					}
					gMap.getDataViz([panelDataViz[1]]);
					$("#map").unOverlay();
					//}
				}
			}
			/**
			 * 3.组装参数
			 */
			sizeObj.analysisType = 0;
			sizeObj.boardId = null;
			sizeObj.boardName = null;
			sizeObj.cityId = sizeObj.cityId;
			sizeObj.cityName = sizeObj.cityName;
			sizeObj.crowd = parameter.peopleIndex;
			sizeObj.indexName = dataIndex;
			sizeObj.ownerId = sizeObj.ownerId;
			//获取选择区域类型
			sizeObj.type = districtArea.dimensionType;
			//获取所选区域id
			sizeObj.selectArea = selectArea;



			/**
			 * 4.加载相关数据
			 */
			//加黄框
			setBorder(sizeObj.crowd);
			//加载配置types
			getTypeArr(sizeObj);
			//人口规模统计信息
			getStatis(sizeObj);
			//人口结构
			getPeopleStruEchartsData(sizeObj);
			//人口偏好
			getpopulationPrefEchartsData(sizeObj);
			//人口价值
			getPopulationValueEchartsData(sizeObj);
			//渲染地图
			getSizeMapData(sizeObj);
			//getHeart(requestObj);

			/**
			 * 5.加在完成数据之后，再次调整因为数据引起改变的央视
			 */
			//隐藏单个版块数据
			$("#changeTop").css('top', "0px");
			//点击应用改变+为-
			$(".but-collap").removeClass("fold");
		});

		/**
		 * 职住迁徙点击应用事件
		 */
		$(document).on('click', '#request-but-stru', function () {
			/**
			 * 1.准备参数
			 */
			//研究类型
			var value = $.extend(true, {}, $('#studyType').getParameter()).studyType;
			//职住迁徙-研究版块,区域选择
			var studyArea = $('#studyArea').GetCityMapControl('districtAreaStd').val();
			/**
			 * 2.修改样式
			 */
			if (value == "home") {
				$("#wIndexSelect_select_text #home").addClass("forbid");
				$("#selectType").text("居住地点");
			} else {
				$("#wIndexSelect_select_text #work").addClass("forbid");
				$("#selectType").text("工作地点");
			}
			//隐藏，显示问题
			if ($("#polygonEffect .control-panel").text() == '显示图层') {
				$("#polygonEffect .control-panel").click();
			}
			if ($("#odControl .control-panel").text() == '显示图层') {
				$("#odControl .control-panel").click();
			}
			//给职住迁徙右侧修改关注度
			$("#select_board").html(studyArea.name + '<span class="subtit gary9" id="select_disctrict">-' + studyArea.districtName + '</span>');
			/**
			 * 3.组装参数
			 */
			struObj.analysisType = struObj.analysisType;
			struObj.boardId = studyArea.id;
			struObj.boardName = studyArea.name;
			struObj.cityId = struObj.cityId;
			struObj.cityName = struObj.cityName;
			struObj.indexName = struObj.indexName;
			if (value == "home") { //研究工作地
				struObj.crowd = 2;
			};
			if (value == "work") { //研究居住地
				struObj.crowd = 1;
			}
			struObj.type = struObj.type;
			struObj.selectArea = [studyArea.id];
			struObj.ownerId = struObj.ownerId;
			/**
			 * 4.加载数据
			 */
			//支柱分析
			getELA(struObj);
			//清除od线
			hideOd();
			//时点人流echarts
			getPopulationCurrentTrafficFlowData(struObj);
			//渲染地图
			getMapDataStru(struObj);
			//获取od图数据
			getOdMapData(struObj);
			/**
			 * 5.处理因为数据引起的央视改变
			 */
			//隐藏单个版块数据
			$("#changeTop").css('top', "0px");
			//点击应用改变+为-
			$(".but-collap").removeClass("fold");



		});

	});
});

/**
 * 公共方法区，
 * 初始化页面所需要的东西，不包括相关的数据
 */
function init(index, mapConfigObj) {
	/**
	 * 1.1初始化页面显示相关问题
	 */
	if (index == 0) {
		$("#peopleIndex .butbox").css("display", "none");
		$("#dataIndex .butbox").css("display", "none");
		$('#rightPeopleSize .hideRight').attr('id', 'hideRight');
		$('#rightPeopleSize .rightModule').attr('id', 'rightModule');
	}
	if (index == 1) {
		$("#wIndex .butbox").css("display", "none");
		$('#rightEmploymentTransfer .hideRight').attr('id', 'hideRight');
		$('#rightEmploymentTransfer .rightModule').attr('id', 'rightModule');
	}
	/**
	 * 初始化查询条件
	 */
	removeTip(); //移除弹框
	hideOd(); //清除od线
	switch (index) {
		case 0: //人口规模
			sizeinitvisual(mapConfigObj.ifclick); //初始化地图插件
			getConditionSize(sizeObj);



			break;
		case 1: //职住迁徙
			struinitvisual(mapConfigObj.ifclick);
			getConditionStru(struObj);
			break;
	};

}

/**
 * 移除弹框
 */
function removeTip() {
	if (gMap != null) { //移除弹框
		tips = gMap.tips || {};
		for (var k in tips) {
			tips[k].destroy();
			gMap.removeMapTip(tips[k]);
		}
	};
};
/**
 * 去除od线
 */
function hideOd() {
	for (var i = 0; i < loc.length; i++) {
		var id = 'OdLine_' + i;
		if (gMap.overlays.odline[id]) {
			gMap.overlays.odline[id].destory();
			delete gMap.overlays.odline[id]; //删除对象
		}

	};

};
//3.初始化人口规模地图控件
function sizeinitvisual(ifclick, callbackde) {
	/**
	 * 参数处理
	 */
	var firstBool = false; //空间页面是关闭的
	/**
	 * 3.1构建画图所需要的dataviz
	 */
	initDataViz(ifclick);
	/**
	 * 3.2控件初始化
	 */
	$("#populationSize").CityMapControl("mapVisualization", [ //面图(版块、街道、区县)
		/**
		 * 3.2.1画面图参数准备
		 */
		{ //面图
			id: 'polygonEffect',
			type: 'polygon',
			tabs: ['polygon-choropleth', 'polygon-simple'],
			section: { //分段指标
				fieldName: $("#app_target").val()
			},
			index: { //地图切换指标配置
				types: cityMapControlType,
			},
			listenShow: function (flag) { //点击事件的监听
				isChange = flag;
				if (polygonMapUid) {
					if (flag) {
						gMap.showDataViz(polygonMapUid);
					} else {
						gMap.hideDataViz(polygonMapUid);
					}
				}

			},
			callback: function (callbackData, backObj, bool) { //回调函数，在setdata后，回调到这里
				/**
				 * 1.修改样式
				 */
				$('#hideMapConfLi .nice-scroll').getNiceScroll().resize(); //隐藏配置地图的滚动条
				/**
				 * 2.获取参数
				 */
				fieldName = callbackData.vizConfig.fieldName; //指标
				//人口规模-指标选择
				var container2 = $('#dataIndex');
				item = people.condition.conditionConfig2['0'];
				var parameter = {};
				parameter = $.extend(true, {}, $('#peopleIndex').getParameter());
				/**
				 * 3.处理参数
				 */
				if (parameter.peopleIndex == 1) {
					//container2.setData(item);
					switch (fieldName) {
						case 'liveDensity':
							item.selected = "0";
							break
						case 'livePeopleCount':
							item.selected = "1";
							break
						case 'employmentRatio':
							item.selected = "2";
							break
					};
					//给插件赋值
					container2.setData(item);
				}
				if (parameter.peopleIndex == 2) {
					//container2.setData(item);
					switch (fieldName) {
						case 'workDensity':
							item.selected = "0";
							break
						case 'workPeopleCount':
							item.selected = "1";
							break
						case 'employmentRatio':
							item.selected = "2";
							break
					};
					container2.setData(item);
				}
				//切网格-指标纯小写
				if ($("#netSize").GetCityMapControl("mapVisualization") && $('.grid-box .btn-switch').hasClass('is-checked')) {
					var netIndex = fieldName.toLowerCase();
					var selectIndex_net = $("#netSize").GetCityMapControl("mapVisualization").getLayer("netEffect");
					$('#netEffect').find('div[data-box=sectionIndex]').find('.citymapControl-select-title').click();
					//$('#netEffect').find('div[data-box=sectionIndex]').find('.citymapControl-select-title').click();
					selectIndex_net.setGrid({
						fieldName: netIndex
					})
				}
				/**
				 * 3.2.2画图例准备
				 */
				var textName; //图例名称
				$.each(cityMapControlType, function (index, value) {
					if (value.value == fieldName) { //成功回调，给图例添加单位
						textName = value.text;
					};
				});
				switch (textName) { //添加值到html页面,包括单位
					case '人口密度':
						textName = '人口密度(人/km²)';
						break;
					case '人口数量':
						textName = '人口数量(万人)';
						break;
					default:
						break;
				}
				$('#indexName').html(textName); //添加图例的名称到页面
				/**
				 * 3.2.3 地图构建相关参数配置
				 */
				if (bool) {
					/**
					 * 3.2.3.1准备参数
					 */
					var callbackConf = callbackData.vizConfig;
					$("#populationMapLegend").html('');
					if (callbackConf.type == 'polygon-choropleth' && callbackData.colorLegend) {
						$("#legend-container").show();
						/**
						 * 3.2.3.2 处理返回的数据，将其画到图例上(包括处理图例的单位和图例的小数位)
						 */
						$.each(callbackData.colorLegend, function (k, v) {
							if (callbackConf.fieldName == 'liveDensity' || callbackConf.fieldName == 'workDensity') { //判断如果人数是小数，则转化为整数
								v.begin = Math.ceil(v.begin) < 0 ? 0 : Math.ceil(v.begin); //人数不能为小数，向上取整
								v.end = Math.ceil(v.end);
								v.range = v.begin + '-' + v.end;
							} else { ///职住比 可以为小数，但是保留两位小数
								v.begin = Math.round(v.begin * 100) / 100;
								v.end = Math.round(v.end * 100) / 100;
								v.range = v.begin + '-' + v.end;
							}
							$("#populationMapLegend").append("<p class='font12'><i style='background-color:" + v.color + "'></i>" + v.range + "</p>"); //画出图例
						});
					} else {
						$("#legend-container").hide();
					};
					callbackConf.labelField = null; //显示版块名称，此处为推到极海的字段名称
					/**
					 * 3.2.3.3配置地图vizconfig
					 */
					panelDataViz[0].vizConfig = callbackConf;
					if (panelDataViz[0].dataUid || panelDataViz[0].dataUid == '') {
						gMap.removeDataViz(panelDataViz[0].dataUid);
					}
					if (polygonMapUid) {

						panelDataViz[0].dataUid = polygonMapUid;

						if (!$('.grid-box .btn-switch').hasClass('is-checked')) {
							$("#map").unOverlay();
						}
						gMap.getDataViz([panelDataViz[0]]);
					}

				};
			}

		}
		// { //面图
		// 	id: 'netEffect',
		// 	type: 'polygon',
		// 	isShow: false,
		// 	tabs: ['polygon-choropleth', 'polygon-simple'],
		// 	section: { //分段指标
		// 		fieldName: $("#app_target").val()
		// 	},
		// 	index: { //地图切换指标配置
		// 		types: cityMapControlType,
		// 	},
		// 	listenShow: function (flag) { //点击事件的监听
		// 		isChange = flag;
		// 		// if (netMapUid) {
		// 		// 	if (flag) {
		// 		// 		gMap.showDataViz(netMapUid);
		// 		// 		// if ($('#netName').next('i').hasClass('')) {

		// 		// 		// }
		// 		// 		$('#netName').next('i').toggleClass('icon-arrow-up').toggleClass('icon-arrow-down');
		// 		// 		$('#netMapLegend').show();
		// 		// 	} else {
		// 		// 		gMap.hideDataViz(netMapUid);
		// 		// 		$('#netName').next('i').toggleClass('icon-arrow-up').toggleClass('icon-arrow-down');
		// 		// 		$('#netMapLegend').hide();
		// 		// 	}
		// 		// }

		// 		if (flag) {
		// 			openNet();
		// 			if (!dimenHasData) {
		// 				sizeObj.dimensionType = dimenConfig[sizeObj.type];
		// 				sizeObj.dimensionIds = sizeObj.selectArea
		// 				console.log(sizeObj);
		// 				dimen(sizeObj);
		// 			}
		// 		} else {
		// 			closeNet()
		// 		}
		// 	},
		// 	callback: function (callbackData, backObj, bool) { //回调函数，在setdata后，回调到这里
		// 		/**
		// 		 * 1.修改样式
		// 		 */
		// 		$('#hideMapConfLi .nice-scroll').getNiceScroll().resize(); //隐藏配置地图的滚动条
		// 		/**
		// 		 * 2.获取参数
		// 		 */
		// 		fieldName = callbackData.vizConfig.fieldName; //指标
		// 		//人口规模-指标选择
		// 		var container2 = $('#dataIndex');
		// 		item = people.condition.conditionConfig2['0'];
		// 		var parameter = {};
		// 		parameter = $.extend(true, {}, $('#peopleIndex').getParameter());
		// 		/**
		// 		 * 3.处理参数
		// 		 */
		// 		if (parameter.peopleIndex == 1) {
		// 			//container2.setData(item);
		// 			switch (fieldName) {
		// 				case 'liveDensity':
		// 					item.selected = "0";
		// 					break
		// 				case 'livePeopleCount':
		// 					item.selected = "1";
		// 					break
		// 				case 'employmentRatio':
		// 					item.selected = "2";
		// 					break
		// 			};
		// 			//给插件赋值
		// 			container2.setData(item);
		// 		}
		// 		if (parameter.peopleIndex == 2) {
		// 			//container2.setData(item);
		// 			switch (fieldName) {
		// 				case 'workDensity':
		// 					item.selected = "0";
		// 					break
		// 				case 'workPeopleCount':
		// 					item.selected = "1";
		// 					break
		// 				case 'employmentRatio':
		// 					item.selected = "2";
		// 					break
		// 			};
		// 			container2.setData(item);
		// 		}

		// 		/**
		// 		 * 3.2.2画图例准备
		// 		 */
		// 		var textName; //图例名称
		// 		$.each(cityMapControlType, function (index, value) {
		// 			if (value.value == fieldName) { //成功回调，给图例添加单位
		// 				textName = value.text;
		// 			};
		// 		});
		// 		switch (textName) { //添加值到html页面,包括单位
		// 			case '人口密度':
		// 				textName = '人口密度(人/km²)';
		// 				break;
		// 			case '人口数量':
		// 				textName = '人口数量(万人)';
		// 				break;
		// 			default:
		// 				break;
		// 		};
		// 		$('#netName').parent().show();
		// 		$('#netMapLegend').show();

		// 		$('#netName').html('网格-' + textName); //添加图例的名称到页面

		// 		/**
		// 		 * 3.2.3 地图构建相关参数配置
		// 		 */
		// 		if (bool) {
		// 			/**
		// 			 * 3.2.3.1准备参数
		// 			 */
		// 			var callbackConf = callbackData.vizConfig;
		// 			$("#netMapLegend").html('');
		// 			if (callbackConf.type == 'polygon-choropleth' && callbackData.colorLegend) {
		// 				$("#legend-container").show();
		// 				/**
		// 				 * 3.2.3.2 处理返回的数据，将其画到图例上(包括处理图例的单位和图例的小数位)
		// 				 */
		// 				$.each(callbackData.colorLegend, function (k, v) {
		// 					if (callbackConf.fieldName == 'liveDensity' || callbackConf.fieldName == 'workDensity') { //判断如果人数是小数，则转化为整数
		// 						v.begin = Math.ceil(v.begin) < 0 ? 0 : Math.ceil(v.begin); //人数不能为小数，向上取整
		// 						v.end = Math.ceil(v.end);
		// 						v.range = v.begin + '-' + v.end;
		// 					} else { ///职住比 可以为小数，但是保留两位小数
		// 						v.begin = Math.round(v.begin * 100) / 100;
		// 						v.end = Math.round(v.end * 100) / 100;
		// 						v.range = v.begin + '-' + v.end;
		// 					}
		// 					$("#netMapLegend").append("<p class='font12'><i style='background-color:" + v.color + "'></i>" + v.range + "</p>"); //画出图例
		// 				});
		// 			} else {
		// 				$("#legend-container").hide();
		// 			};
		// 			callbackConf.labelField = null; //显示版块名称，此处为推到极海的字段名称

		// 			if (callbackConf.fieldName) {
		// 				callbackConf.fieldName = callbackConf.fieldName.toLowerCase(); //显示版块名称，此处为推到极海的字段名称
		// 			}

		// 			/**
		// 			 * 3.2.3.3配置地图vizconfig
		// 			 */
		// 			var ids = sizeObj.selectArea.join(',');
		// 			//获取选择区域
		// 			var betArea = $('#districtAreaSelect').GetCityMapControl('districtAreaStd').val();
		// 			if (!betArea.isall) {
		// 				panelDataViz[1].filter = sizeObj.type + '_id in (' + ids + ')'
		// 			} else {
		// 				panelDataViz[1].filter = ""
		// 			}
		// 			//配置=0的网格
		// 			var fillObj = {
		// 				"fillColor": "#CFCFCF",
		// 				"value": 0,
		// 				"fillOpacity": 0.9
		// 			};
		// 			callbackConf.buckets.push(fillObj);
		// 			callbackConf.outlineWidth = 0.1
		// 			panelDataViz[1].vizConfig = callbackConf;
		// 			if (panelDataViz[1].dataUid || panelDataViz[1].dataUid == '') {
		// 				gMap.removeDataViz(panelDataViz[1].dataUid);
		// 			}
		// 			if (netMapUid) {

		// 				panelDataViz[1].dataUid = netMapUid;
		// 				$("#map").unOverlay(); //取消loading
		// 				gMap.getDataViz([panelDataViz[1]]);
		// 			}

		// 		};
		// 	}

		// }
	])
	//网格渲染改名、
	//$('#netEffect .panel-head-title span').html('网格渲染')
};
/**
 * 初始化人口规模区域选择条件
 */
function getConditionSize(sizeObj) {
	$('#districtAreaSelect').CityMapControl('districtAreaStd', {
		/**
		 * 1.区域类型，版块，街道，区县
		 */
		cityId: sizeObj.cityId,
		ownerId: sizeObj.ownerId,
		jsonVersion: areaSelectVersion,
		dimensionConfigPath: dimensionconfigpath,
		dimensions: [{
			value: 'board',
			text: '板块'
		}, {
			value: 'street',
			text: '街道'
		}],
		all: 'board',
		eventListener: {
			dimensionChange: function (data) {},
			click: function (data) {},
			callback: function (data) {
				/**
				 * 2.样式修改
				 */
				//去掉多余的横线
				$("#peopleIndex .butbox").css("display", "none");
				$("#dataIndex .butbox").css("display", "none");
				people.condition.load(); //加载数据选择和指标选择
				/**
				 * 3.组装访问参数
				 */
				var selectArea = $.map(data.data, function (item) {
					return [parseInt(item.id)]
				});
				//人口规模-数据选择
				var parameter = {};
				parameter = $.extend(true, {}, $('#peopleIndex').getParameter());
				//人口规模-指标选择
				var p = $.extend(true, {}, $('#dataIndex').getParameter());
				dataIndex = p.dataIndex ? p.dataIndex : '0';
				/**
				 * 4.组装参数
				 */
				sizeObj.analysisType = sizeObj.analysisType;
				sizeObj.cityId = sizeObj.cityId;
				sizeObj.cityName = sizeObj.cityName;
				sizeObj.boardId = sizeObj.boardId;
				sizeObj.boardName = sizeObj.boardName;
				sizeObj.crowd = parameter.peopleIndex;
				sizeObj.indexName = dataIndex;
				sizeObj.type = data.dimensionType
				sizeObj.ownerId = sizeObj.ownerId;
				sizeObj.selectArea = selectArea;
				/**
				 * 5.加载右侧相关数据
				 */
				//加黄框
				setBorder(sizeObj.crowd);
				//封装指标参数
				getTypeArr(sizeObj);
				//人口规模统计信息
				getStatis(sizeObj);
				//人口偏好
				getpopulationPrefEchartsData(sizeObj);
				//人口价值
				getPopulationValueEchartsData(sizeObj);
				//渲染地图
				getSizeMapData(sizeObj);
				//getHeart(sizeObj);
				//人口结构
				getPeopleStruEchartsData(sizeObj);
			}
		}
	});
}
//4.初始化职住迁徙地图控件
function struinitvisual(ifclick) {
	/**
	 * 参数处理
	 */
	var firstBool = false; //空间页面是关闭的
	ifclick = false; //不允许点击版块
	/**
	 * 3.1构建画图所需要的dataviz
	 */
	initDataViz(ifclick);
	/**
	 * 3.2控件初始化
	 */
	$("#populationSize").CityMapControl("mapVisualization", [ //面图(版块、街道、区县)
		/**
		 * 3.2.1画面图参数准备
		 */
		{ //面图
			id: 'polygonEffect',
			type: 'polygon',
			tabs: ['polygon-choropleth', 'polygon-simple'],
			section: { //分段指标
				fieldName: $("#app_target").val()
			},
			index: { //地图切换指标配置
				types: struTypes,
			},
			listenShow: function (flag) { //点击事件的监听
				isChange = flag;
				if (flag) {
					gMap.showDataViz(polygonMapUid);
				} else {
					gMap.hideDataViz(polygonMapUid);
				}
			},
			callback: function (callbackData, backObj, bool) { //回调函数，在setdata后，回调到这里
				/**
				 * 1.修改样式
				 */
				$('#hideMapConfLi .nice-scroll').getNiceScroll().resize(); //隐藏配置地图的滚动条
				/**
				 * 2.获取参数
				 */
				fieldName = callbackData.vizConfig.fieldName; //指标
				/**
				 * 3.处理参数
				 */

				//给插件赋值
				//container.setData(item)
				/**
				 * 3.2.2画图例准备
				 */
				var textName; //图例名称
				var value = $.extend(true, {}, $('#studyType').getParameter()).studyType;
				if (value == "work") {
					textName = '居住地分布(人数)';
				} else {
					textName = '工作地分布(人数)';
				};
				switch (textName) { //添加值到html页面,包括单位
					case '居住地分布(人数)':
						textName = '居住地分布人数(人)';
						break;
					case '工作地分布(人数)':
						textName = '工作地分布人数(人)';
						break;
				}
				$('#indexName').html(textName); //添加图例的名称到页面
				/**
				 * 3.2.3 地图构建相关参数配置
				 */
				if (bool) {
					/**
					 * 3.2.3.1准备参数
					 */
					var callbackConf = callbackData.vizConfig;
					$("#populationMapLegend").html('');
					if (callbackConf.type == 'polygon-choropleth' && callbackData.colorLegend) {
						$("#legend-container").show();
						/**
						 * 3.2.3.2 处理返回的数据，将其画到图例上(包括处理图例的单位和图例的小数位)
						 */
						$.each(callbackData.colorLegend, function (k, v) {
							if (callbackConf.fieldName == 'indexValue') { //判断如果人数是小数，则转化为整数
								v.begin = Math.ceil(v.begin) < 0 ? 0 : Math.ceil(v.begin); //人数不能为小数，向上取整
								v.end = Math.ceil(v.end);
								v.range = v.begin + '-' + v.end;
							} else { //职住比，密度可以为小数，但是保留两位小数
								v.begin = Math.round(v.begin * 100) / 100;
								v.end = Math.round(v.end * 100) / 100;
								v.range = v.begin + '-' + v.end;
							}
							$("#populationMapLegend").append("<p class='font12'><i style='background-color:" + v.color + "'></i>" + v.range + "</p>"); //画出图例
						});
					} else {
						$("#legend-container").hide();
					};
					callbackConf.labelField = null; //显示版块名称，此处为推到极海的字段名称
					/**
					 * 3.2.3.3配置地图vizconfig
					 */
					panelDataViz[0].vizConfig = callbackConf;
					if (panelDataViz[0].dataUid || panelDataViz[0].dataUid == '') {
						gMap.removeDataViz(panelDataViz[0].dataUid);
					}
					panelDataViz[0].dataUid = polygonMapUid;
					$("#map").unOverlay(); //取消loading
					gMap.getDataViz([panelDataViz[0]]);
				};
			}

		},
		{ //od图
			id: "odControl",
			type: 'od',
			isShow: true,
			index: {
				types: struTypes
			},
			listenShow: function (flag) {

				if (flag) {
					if (odStates) {
						hideOd();
						creatOD()
					} else {
						odStates = flag;
						creatOD()
					}
				} else {
					if (gMap.overlays.odline) {
						hideOd();
					}
					odStates = flag;
				}
			},
			callback: function (callbackData, backObj, bool) {

				$(".nice-scroll").niceScroll(nice_scroll_classobj);
				$(".nice-scroll").getNiceScroll().resize();

				odColor = callbackData.colorLegend;

				odViz = callbackData.vizConfig;
				if (bool) {
					if (odStates) {
						hideOd(); //清除od线
						creatOD();
						odStates = true;
					} else {
						creatOD()
						odStates = true;
					}

				}

			}

		}

	])

};
/**
 * 获取职住迁徙的查询条件
 */

function getConditionStru(struObj) {
	$('#studyArea').CityMapControl('districtAreaStd', {
		/**
		 * 1.区域类型：版块
		 */
		cityId: struObj.cityId,
		ownerId: struObj.ownerId,
		type: 'select',
		dimensions: [{
			value: 'board',
			text: '板块'
		}],
		eventListener: {
			click: function (data) {

			},
			dimensionChange: function (data) {},
			callback: function (data) {
				/**
				 * 2.样式修改
				 */
				var str = '<div class="form-row clearfix mt05" id="studyType" ></div>';
				//let areaData = $('#districtAreaSelect').GetCityMapControl('districtAreaStd');
				//console.log($(data.container).find('.boardUL li').length);
				//获取有板块数据的区县行数
				let districtNum = $(data.container).find('.boardUL li').length;
				//console.log(data);
				if (districtNum > 1) {
					$(data.container).find('.boardUL li').eq(0).find('.sub-content').eq(2).find('a').eq(0).click();
				} else {
					$(data.container).find('.boardUL li').eq(0).find('.sub-content').eq(0).find('a').eq(0).click();
				}

				$(data.container).find('.panel-body').prepend(str);
				people.condition2.load();
				//修改区域选择为数据选择
				$("#studyArea .panel-head-title").html("<span>数据选择</span>");
				$("#odControl").css("display", "block");
				//去掉多余线框
				$("#wIndex .butbox").css("display", "none");
				//修改职住迁徙关注地样式
				$("#studyArea .gray6").addClass("form-labels form-labels-wid01");
				$("#studyArea .gray6").text("研究对象");
				$("#studyArea .gray6").removeClass("gray6 form-label");
				$(".focus-city").css("text-indent", "6px");
				//职住迁徙-类型指标互动
				var container4 = $('#wIndex');
				var item = people.condition2.conditionConfig4[0];
				container4.setData(item);
				//研究类型参数
				var value = $.extend(true, {}, $('#studyType').getParameter()).studyType;
				if (value == "work") {
					item.selected = "home";
					$("#wIndexSelect_select_text #work").addClass("forbid");
				} else {
					item.selected = "work";
					$("#wIndexSelect_select_text #home").addClass("forbid");
				};
				//给职住迁徙右侧修改关注度
				$("#select_board").html(data._selectData.name + '<span class="subtit gary9" id="select_disctrict">-' + data._selectData.districtName + '</span>');
				/**
				 * 3.获取参数
				 */

				/**
				 * 4.组装参数
				 */
				struObj.analysisType = struObj.analysisType;
				struObj.boardId = data._selectData.id;
				struObj.boardName = data._selectData.name;
				struObj.cityId = struObj.cityId;
				struObj.cityName = struObj.cityName;

				if (value == 'home') { //研究工作地
					struObj.crowd = 2;
				};
				if (value == 'work') { //研究居住地
					struObj.crowd = 1;
				};
				struObj.indexName = struObj.indexName;
				struObj.ownerId = struObj.ownerId;
				struObj.type = struObj.type;
				struObj.selectArea = [data._selectData.id];
				/**
				 * 5.加载右侧数据
				 */
				//清除od线
				hideOd();
				//支柱分析
				getELA(struObj);
				//时点人流echarts
				getPopulationCurrentTrafficFlowData(struObj);
				//渲染地图
				getMapDataStru(struObj);
				//获取od图数据
				getOdMapData(struObj);
				//od图
				//creatOD();
			},
			change: function (data) { //点击人口规模，该事件响应
				//职住迁徙-研究版块
				//studyArea = data;
			}
		}
	})
}
//初始化dataViz(未使用)
function initDataViz(ifclick) {
	//面图dataviz
	panelDataViz = [{
		"dataUid": '',
		"dataType": 'tmp',
		"vizConfig": {},
		"animated": false,
		"frameCount": 5,
		"duration": 1,
		"timeAccumulate": false,
		"show": true,
		"zIndex": 0,
		"eventListener": {
			click: function (e, data) {
				if (!ifclick) { //是否允许点击版块
					return;
				}
				if (data.boardId == null) { //无数据不可点击
					return;
				}
				var id = 'mapTip_distrct_' + data.sid,
					tips = gMap.tips || {};

				for (var k in tips) { //隐藏上次的tip
					if (k != id && !tips[k].opts.screwed) {
						tips[k].destroy();
						gMap.removeMapTip(tips[k]);
					}
				}

				tip = new cityGMap.tip(gMap, {

					type: 'mapTip',
					id: 'mapTip_distrct_' + data.sid, //表示第几个弹窗
					point: [e.mapX, e.mapY],
					innerHtml: getinnerHtml(data),

					className: 'suspendbox',
					draggable: 'enable',

					eventListener: {
						mouseover: function (e, t) {
							t.$node.find('.btn-close').show();
						},
						mouseout: function (e, t) {
							t.$node.find('.btn-close').hide();
						},
						close: function (e) {
							e.parent().remove();
						}
					}
				});
				gMap.addMapTip(tip); //添加弹窗
				addhtml(data); //添加点击页面代码\n
			}
		}
	}, {
		"dataUid": '',
		"dataType": 'private',
		"vizConfig": {},
		"animated": false,
		"frameCount": 5,
		"duration": 1,
		"timeAccumulate": false,
		"show": true,
		"zIndex": 1,
		"interactivity": ["livedensity", "livepeoplecount", "employmentratio", 'workdensity', 'workpeoplecount', 'sid'],
		eventListener: {
			// mousemove: function (data) {
			// 	console.log(fieldName);

			// 	if (data.data && data.data[fieldName] && data.data[fieldName] != 0) {
			// 		var tips = gMap.tips || {};
			// 		var id = data.data.sid;
			// 		for (var k in tips) { //隐藏上次的tip
			// 			if (k != id && !tips[k].opts.screwed) {
			// 				tips[k].destroy();
			// 				gMap.removeMapTip(tips[k]);
			// 			}
			// 		}
			// 		data.point[1] -= 10;
			// 		var _point = gMap.gmap.toMap(data.point);
			// 		nettip = new cityGMap.tip(gMap, {
			// 			type: 'mapTip',
			// 			id: data.data.sid,
			// 			point: _point,
			// 			innerHtml: `<span style="white-space:nowrap;background:#fff;padding: 1px 3px;border-radius:2px;width:100px">${data.data[fieldName] + netUnit} </span>`,
			// 			className: 'netTip'
			// 		});
			// 		gMap.addMapTip(nettip); //添加弹窗
			// 	} else {
			// 		// if (data.data) {
			// 		var tips = gMap.tips || {};
			// 		// 	var id = data.data.sid;
			// 		for (var k in tips) { //隐藏上次的tip
			// 			// 		if (k != id && !tips[k].opts.screwed) {
			// 			tips[k].destroy();
			// 			gMap.removeMapTip(tips[k]);
			// 		}
			// 		// 	}
			// 		// }

			// 	}
			// }
		}
		//"outlineWidth": 0.1
	}];
	pointDataViz = [{ //点图dataViz
		"dataUid": '',
		"dataType": "tmp",
		"show": false,
		"zIndex": 2,
		"vizConfig": {}

	}];
};
/**
 * 放入职住分析数据
 * @param {Object} data
 */
function setELA(data) {
	var container = $('#ELA');
	//判断有无数据
	if (data == null || data == "" || data == undefined || data.populationEmploymentAnalysisDataDto[0].peopleNum == undefined) {
		container.html('<div class="no-content" style=""><p class="text-center col_white no-margin thinblue"><em class="icon_no_data"></em>暂无相关数据</p></div>');
		$('#workplaceEchartsBody').html('<div class="no-content" style="height:200px;padding-top:30%;"><p class="text-center col_white no-margin thinblue"><em class="icon_no_data"></em>暂无相关数据</p></div>');
		return;
	};
	//处理数据
	var sum = data.populationEmploymentAnalysisDataDto[0].peopleNum + data.populationEmploymentAnalysisDataDto[1].peopleNum;
	var locper = ((data.populationEmploymentAnalysisDataDto[0].peopleNum) / sum).toFixed(2) * 100;
	var unlocper = ((data.populationEmploymentAnalysisDataDto[1].peopleNum) / sum).toFixed(2) * 100;
	ELAdata = data;
	var text;
	if (container != null && container != "" && container != undefined) {
		container.empty();
		//获取研究类型
		var value = $.extend(true, {}, $('#studyType').getParameter()).studyType;
		if (value == 'home') { //研究居住地
			text = '工作';
		};
		if (value == 'work') { //研究工作地地
			text = '居住';
		};
		let localStr = "暂无相关数据";
		let unLoccaStr = "暂无相关数据";

		if (data.populationEmploymentAnalysisDataDto[0].peopleNum) {
			localStr = data.populationEmploymentAnalysisDataDto[0].peopleNum + '人'
		}
		if (data.populationEmploymentAnalysisDataDto[1].peopleNum) {
			unLoccaStr = data.populationEmploymentAnalysisDataDto[1].peopleNum + '人'
		}
		container.append(`
            <div class="local-work">
                <p>本地` + text + `</p>
                <p class="font14">` + localStr + `</p>
            </div>
            <div class="analy-pic">
                <div class="analy-data-bar"  style="width:` + locper + `%;" title="` + locper + `%" id="localwork" ></div>
                <div class="analy-bar" title="` + unlocper + `%" id="unlocalwork" style="width:` + unlocper + `%;"></div>
            </div>
            <div class="nonlocal-work">
                <p>外市` + text + `</p>
                <p class="font14">` + unLoccaStr + `</p>
            </div>
        </div>


        `)
	}
	//职住分析echarts
	workplaceEcharts(ELAdata.populationEmploymentAnalysisTopDto, "本市" + text + "TOP5");
	clickBar(text);
}

/**
 * 点击职住迁徙，职住分析事件
 */
function clickBar(text) {
	$(document).on('click', '.analy-data-bar', function (e) {
		//样式
		$('.analy-bar').css('height', '14px');
		$('.analy-bar').css('margin-top', '0px');
		$('.analy-data-bar').css('height', '20px');
		$('.analy-data-bar').css('margin-top', '-3px');
		//e.stopPropagation(); //阻止冒泡
		if (ELAdata.populationEmploymentAnalysisTopDto != 'undefined') {
			workplaceEcharts(ELAdata.populationEmploymentAnalysisTopDto, "本市" + text + "地TOP5")
		}

	});

	$(document).on('click', '.analy-bar', function () {
		//样式
		$('.analy-bar').css('height', '20px');
		$('.analy-bar').css('margin-top', '-3px');
		$('.analy-data-bar').css('margin-top', '0px');
		$('.analy-data-bar').css('height', '14px');

		workplaceEcharts(ELAdata.populationEmploymentAnalysisOtherTopDto, "外市" + text + "地TOP5")
	});
};
/**
 *
 * 职住分析
 *TODO 加参数
 * */

function getELA(obj) {
	obj.num = 5;
	var resReq2 = JSON.stringify(obj);
	getResData(resReq2);
	/**
	 * 请求职住分析
	 * @param {Object} data
	 */

	function getResData(data) {

		/*  $("#home_workChartDiv").overlay();
		 $("#home_workChart").hide();*/
		$.request({
			url: contextPath + '/dataanalysis/people/2.0/index/getPopulationEmploymentAnalysisInfo',
			type: 'post',
			headers: {
				"Content-Type": "application/json"
			},
			data: data,
			dataType: 'json',
			success: function (jsonData) {
				setELA(jsonData.data);
			},
			error: function (errorResult) {}
		})
	}
}
/**
 * 加黄框
 */
function setBorder(index) {
	if (index == 1) {
		$(".work-peo").css("border", "none");
		$(".live-peo").css("border", "3px solid #f9e44e");
		//obj.crowd = index;
	} else {
		$(".live-peo").css("border", "none");
		$(".work-peo").css("border", "3px solid #f9e44e");
		//obj.crowd = index;
	}
}
/**
 *
 * 统计信息
 *
 * */

function setStatis(data) {
	var container = $('#statis');
	//判断有无数据
	if (data == null || data == "" || data == undefined || data.populationSizeStatisticsDtos == null) {
		container.html('<div class="no-content" style=""><p class="text-center col_white no-margin thinblue"><em class="icon_no_data"></em>暂无相关数据</p></div>');
		return;
	}
	//人口规模-数据选择
	var parameter = {};
	parameter = $.extend(true, {}, $('#peopleIndex').getParameter());
	var pIndex = parameter.peopleIndex;
	//获取指标对应数据
	var showData = data.populationSizeStatisticsDtos[dataIndex];
	//单位
	var str = dataIndex == '0' ? "人/km²" : "万人";
	//获取长度
	var workl;
	var homel;
	if (showData.employmentRatio < 1) {
		homel = "100%";
		workl = showData.employmentRatio * 100 + "%";
	} else {
		workl = "100%";
		homel = (((showData.inhabitedPopulation) / (showData.workingPopulation)).toFixed(2)) * 100 + "%"
	}

	//将原来div置空
	if (container != null && container != "" && container != undefined) {
		container.empty();
		container.append(`<div class="form-row clearfix live-work-ratio">
            <div class="fl ratio-data">
                <p>职住比</p>
                <p class="font20 f_arial">` + showData.employmentRatio + `</p>
            </div>
            <div class="ratio-pic-show fl">
                <div class="live-peo clearfix">
                    <p class="fl">居住人口</p>
                    <div class="account-bar-box fl">
                        <div class="account-bar" style="width:` + homel + `">
                            <span class="gray9 fl data">` + showData.inhabitedPopulation + `` + str + `</span>
                        </div>
                    </div>

                </div>
                <div class="work-peo clearfix">
                    <p class="fl">工作人口</p>
                    <div class="account-bar-box fl">
                        <div class="account-bar" style="width:` + workl + `">
                            <span class="gray9 fl data">` + showData.workingPopulation + `` + str + `</span>
                        </div>
                    </div>

                </div>
            </div>
        </div>`);
	}
	//根据数据选择指标加框
	setBorder(pIndex)
	//职住分析echarts
	//workplaceEcharts(data.populationEmploymentAnalysisTopDto, "本市工作地TOP5");

}
/**
 * 人口规模-统计信息
 */
function getStatis(obj) {
	var resReq2 = JSON.stringify(obj);
	getResData(resReq2);

	function getResData(data) {

		/*  $("#home_workChartDiv").overlay();
		 $("#home_workChart").hide();*/
		$.request({
			url: contextPath + '/dataanalysis/people/2.0/index/getPopulationSizeStatisticalInfo',
			type: 'post',
			headers: {
				"Content-Type": "application/json"
			},
			data: data,
			dataType: 'json',
			success: function (jsonData) {
				setStatis(jsonData.data);
			},
			error: function (errorResult) {}
		})
	}

}

//添加html代码
function addhtml(data) {
	/**
	 * 1.拼装要显示的数据
	 */
	var sid = data.sid; //极海的板块id
	var sname = data.boardName; //极海的板块名称
	var districtName = '';
	var districtArea = $('#districtAreaSelect').GetCityMapControl('districtAreaStd').val();
	for (var i = 0; i < districtArea.data.length; i++) {
		var arrobj = districtArea.data[i];
		if (sid == arrobj.id) {
			districtName = arrobj.districtName;
			break;
		};
	};

	//人口规模-数据选择
	var parameter = {};
	parameter = $.extend(true, {}, $('#peopleIndex').getParameter());
	//人口规模-指标选择
	var p = $.extend(true, {}, $('#dataIndex').getParameter());
	dataIndex = p.dataIndex ? p.dataIndex : '0';
	//处理null问题
	var boardName = (sname.length > 10) ? (sname.substr(0, 10) + '...') : sname;
	var innerHtml;
	var areaNature;
	/**
	 * 2.处理点击版块的逻辑
	 */
	if (data.areaNature != null) {
		areaNature = data.areaNature;
	} else {
		areaNature = '';
	};
	//class="gary9 fl ml10 data-date" ,样式可能会用到
	innerHtml = `<h2 class="tit-text fl">` + boardName + `<span class="subtit gary9">-` + districtName + `</span></h2>
									<span style="background-color: deepskyblue;width: 50px;">` + areaNature + `</span>
									<a href="javascript:loadHtml()" class="btn-back fr cornerbg mt10">
										<span class="icon-back"></span>
									</a>
									`;

	$("#addhtml").html(innerHtml);
	$("#changeTop").css('top', "30px");

	//传入人口规模点击版块时产生的值
	var boardInfoObj = {
		"analysisType": 0,
		"boardId": data.sid,
		"boardName": data.sname,
		"cityId": cityId,
		"cityName": cityName,
		"crowd": parameter.peopleIndex,
		"ownerId": "standard",
		"selectArea": [data.sid],
		"type": districtArea.dimensionType, //需要添加街道和版块
		"indexName": dataIndex
	}

	//人口规模统计信息
	getStatis(boardInfoObj);
	//人口结构
	getPeopleStruEchartsData(boardInfoObj);
	//人口偏好
	getpopulationPrefEchartsData(boardInfoObj);
	//人口价值
	getPopulationValueEchartsData(boardInfoObj);

};

/**
 * 创建od图(画出od)
 * @param {Object} index
 */
function creatOD() {
	$.each(loc, function (i, j) {
		var color;
		$.each(odColor, function (k, item) {
			if (j.value < item.end && j.value > parseInt(item.begin)) {
				color = item.color;
				return true
			};
		});

		var param = {
			baseMap: gMap,
			unlineWidth: 2,
			centerPoint: cityGMap.PointService.Baidu.mercator(j.centerPoint),
			targetPoint: cityGMap.PointService.Baidu.mercator(tar),
			curvature: odViz.curvature,

			duration: 2,
			repeatCount: -1,
			//lineColor:odViz.buckets[i].lineColor,
			UnlineColor: color,
			symbol: odViz.symbol,

			bucketCount: odViz.bucketCount,

			fillOpacity: odViz.fillOpacity,
			lineOpacity: odViz.fillOpacity,

		};
		id = 'OdLine_' + i;
		var ODline = new cityGMap.createOD(param);
		gMap.addOverlay('odline', id, ODline);
		ODline.layer.play();

		//ODline.bringToTop();
	});

};
/**
 *
 * @param {Number} peopleIndex数据选择
 * @param {Number}value指标选择
 */
function getPeopleIndex(peopleIndex, value) {
	var sekstr;

	if (peopleIndex == 1) {
		switch (value) {
			case 0:
				sekstr = "liveDensity";
				break
			case 1:
				sekstr = "livePeopleCount";
				break
			case 2:
				sekstr = "employmentRatio";
				break
		}
	}
	if (peopleIndex == 2) {
		switch (value) {
			case 0:
				sekstr = "workDensity";
				break
			case 1:
				sekstr = "workPeopleCount";
				break
			case 2:
				sekstr = "employmentRatio";
				break
		}
	}
	return sekstr.toLocaleLowerCase();
}