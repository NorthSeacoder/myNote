G.Layer.Graphic=G.Layer.Graphic.extend({_update:function(){var e=this;e._draw()},_draw:function(){var e=this,t=e._map,a=e._ctx=t._useOffScreen?t._offScreenCtx:t._onScreenCtx;a.save();var r,i,o=t.getRedrawExtent(),n=e._tree.search(o).sort(e._sortIndex);for(var l in n)r=n[l],i=r.bbox,r._layer&&G.ExtentUtil.overlaps(i,o)&&r._draw();a.restore()}}),G.Layer.Grid=G.Layer.Grid.extend({_update:function(){var e=this;e._draw()},_draw:function(){var e=this,t=e.options,a=e._map,r=a._useOffScreen?a._offScreenCtx:a._onScreenCtx,i=t.center,o=t.size,n=a._canvasOffset,l=(a.options.maxExtent,a.getRedrawExtent()),s=[i[0]+Math.ceil((l[0]-i[0])/o)*o-l[0],i[1]+Math.ceil((l[1]-i[1])/o)*o-l[1]];r.save(),r.beginPath();for(var _=l[0];_<l[2];_+=o){var c=a.toScreen([_+s[0],l[1]]),d=a.toScreen([_+s[0],l[3]]);r.moveTo(c[0]+n[0],c[1]+n[1]),r.lineTo(d[0]+n[0],d[1]+n[1])}for(var f=l[1];f<l[3];f+=o){var c=a.toScreen([l[0],f+s[1]]),d=a.toScreen([l[2],f+s[1]]);r.moveTo(c[0]+n[0],c[1]+n[1]),r.lineTo(d[0]+n[0],d[1]+n[1])}r.strokeStyle=t.lineColor,r.lineWidth=t.lineWidth,r.globalAlpha=t.lineOpacity,r.stroke(),r.restore()}}),G.Layer.Html=G.Layer.Html.extend({_placeHtml:function(e){var t=this,a=(G.MathUtil,G.Browser.getPxRatio()),r=(a[0],a[1],t._map),i=(r._rotate,r._res,t.options,G.DomUtil),o=t._zoomScale||t._scale,n=t._aroundScreen,l=r.toScreen(e.geom,n,o),s=l[0],_=l[1];t._hidden?i.hide(e):i.show(e),i.markPosTransform(e,s,_),i.updateTransform(e)},_onZoom:function(){var e=this,t=e._map;t._rotate,G.DomUtil;if(e._zooming)return e._tempScale==e._latestTempScale?void e._erase():void(e._latestTempScale=e._tempScale)},_onRotate:function(){var e=this;e._draw()},_onPinch:function(){var e=this;e._draw()}}),G.Layer.Image=G.Layer.Image.extend({_initContainer:function(){var e=this,t=e._map;e.addListener("imageSuccess",t._requestRedraw,t)},_destroyContainer:function(){var e=this,t=e._map;e.removeListener("imageSuccess",t._requestRedraw,t)},_update:function(){var e=this,t=e._map;t._isLoaded()&&e._draw()},_draw:function(){var e,t,a=this,r=a._map,i=a.options,o=a._ctx=r._useOffScreen?r._offScreenCtx:r._onScreenCtx,n=i.opacity<1;n&&(o.save(),o.globalAlpha=i.opacity);for(t in a._images)e=a._images[t],e._loaded&&a._placeImage(e);n&&o.restore()},_placeImage:function(e){if(e._loaded){var t=this,a=G.MathUtil,r=G.Browser.getPxRatio(),i=r[0],o=r[1],n=t._map,l=n._res,s=n._rotate,_=e.bbox,c=_[0],d=_[1],f=t._zoomScale||t._scale,u=t._aroundScreen,v=(_[2]-_[0])/l,h=(_[3]-_[1])/l;f&&1!==f&&(v/=f,h/=f);var p=n.toScreen([c,d],u,f),g=p[0],m=p[1],y=n._canvasOffset;g+=y[0],m+=y[1];var x=t._ctx;s&&(x.save(),x.translate(g,m),x.rotate(s/a.DEGREE_PER_RADIAN),x.translate(-g,-m));try{x.drawImage(e,g,m-h/o,v/i,h/o)}catch(C){}s&&x.restore()}},_onZoomStart:function(){},_onZoomUpdate:function(){},_onZoomEnd:function(){}}),G.Layer.Tile=G.Layer.Tile.extend({canvasFilter:{filters:["gray","dark","negative"],gray:function(e){for(var t=0,a=e.length;t<a;t+=4){var r=(e[t]+e[t+1]+e[t+2])/3;e[t]=e[t+1]=e[t+2]=r}},dark:function(e){for(var t=0,a=e.length;t<a;t+=4){var r=(e[t]+e[t+1]+e[t+2])/3;e[t]=e[t+1]=e[t+2]=255-r}},negative:function(e){for(var t=0,a=e.length;t<a;t+=4)e[t]=255-e[t],e[t+1]=255-e[t+1],e[t+2]=255-e[t+2]}},_initContainer:function(){var e=this,t=e._map;e.addListener("tileSuccess",t._requestRedraw,t),e.addListener("allLoaded",t._requestRedraw,t)},_destroyContainer:function(){var e=this,t=e._map;e.removeListener("tileSuccess",t._requestRedraw,t),e.removeListener("allLoaded",t._requestRedraw,t)},_update:function(){var e=this,t=e._map;if(t._isLoaded()){var a,r,i,o,n,l,s,_,c,d,f,u=e._zoom=e._calcNearestZoom(!0),v=e._calcVisTileInfos(!0),h=(t.getSize(),t.getCenter()),p=e.options,g=p.zoomReses[u],m=p.tileSize,y=t.getDrawSize(),x=1+2*t.options.canvasExpandFactor,C=y[0]*x,w=y[1]*x,S=h[0]-C*g/2,D=h[0]+C*g/2,O=h[1]-w*g/2,L=h[1]+w*g/2,b=[S,O,D,L],E=t.options.maxExtent,R=p.filter=G.Util.trim(e.options.filter),T=e.canvasFilter.filters;e._redrawExtent=b;var P=G.ExtentUtil.intersect(b,E);R&&T.indexOf(R)<0&&(p.filter="",console.error("滤镜参数错误"));for(var M in e._tiles)i=e._tiles[M],o=i._info,a=o[0],r=o[1],n=o[2],f=p.zoomReses[n],n!==u&&(e._stopLoadingTile(i),(!p.keepResample||p.opacity<1)&&e._removeTile(M)),l=p.originX+a*m*f,s=p.originX+(a+1)*m*f,_=p.originY-(r+1)*m*f,c=p.originY-r*m*f,d=G.ExtentUtil.overlaps([l,_,s,c],P),d||e._tileInfoExist(o,v)||e._removeTile(M);var U=e._calcTileIndex(h[0],h[1],u);e._sortTileInfos(v,U[0],U[1]),e._addTiles(v),e._draw()}},_draw:function(){var e,t,a,r,i,o,n=this,l=n._map,s=n.options,_=n._ctx=l._useOffScreen?l._offScreenCtx:l._onScreenCtx,c=n._zoom,d=s.opacity<1;d&&(_.save(),_.globalAlpha=s.opacity);for(o in n._tiles)e=n._tiles[o],t=e._info,i=parseInt(t[2]),!e._loaded||i===c||!s.keepResample||s.opacity<1||(a=parseInt(t[0]),r=parseInt(t[1]),n._placeTile(e,a,r,i));for(o in n._tiles)e=n._tiles[o],t=e._info,i=parseInt(t[2]),e._loaded&&i===c&&(a=parseInt(t[0]),r=parseInt(t[1]),n._placeTile(e,a,r,i));d&&_.restore()},_placeTile:function(e,t,a,r){if(e._loaded){var i=Math.round,o=this,n=G.MathUtil,l=G.Browser.getPxRatio(),s=l[0],_=l[1],c=o._map,d=c._rotate,f=c._res,u=o.options,v=c.options,h=u.tileSize,p=u.zoomReses[r],g=h*p,m=u.tileEnlarge&&(!!(d%90)||G.Browser.gecko||G.Browser.safari),y=u.filter,x=(o.canvasFilter.filters,Math.ceil(g/f)+(m?2:0)),C=u.originX+t*g,w=u.originY-a*g,S=o._zoomScale||o._scale,D=o._aroundScreen;if(S&&1!==S&&(x/=S),!(x>4*(h+2)||x<h/8)){var O=0,L=0,b=v.maxExtent,E=b[2]-b[0];if(v.wrap){var R=o._redrawExtent;R&&b&&(L=Math.floor((R[0]-u.minX)/E)-1,O=Math.ceil((R[2]-u.maxX)/E)+1)}for(var T=L;T<=O;T++){var P=C+T*E,M=w,U=c.toScreen([P,M],D,S),I=U[0],A=U[1],k=c._canvasOffset;I+=k[0],A+=k[1],m&&(I-=1,A-=1),I=i(I),A=i(A);var W=o._ctx;d&&(W.save(),W.translate(I,A),W.rotate(d/n.DEGREE_PER_RADIAN),W.translate(-I,-A));try{var V=y?e._canvas:e;W.drawImage(V,I,A,i(x/s),i(x/_))}catch(N){}d&&W.restore()}}}},_addTiles:function(e){var t=this;if(0!==e.length){t._numLoad=e.length,t._numLoadSuccess=0,t._numLoadError=0;for(var a,r,i,o,n,l,s,_=t.options,c=(_.zoomReses.length,t.options.errorTileUrl||G.Layer.Tile.EMPTY_TILE),d=0,f=e.length;d<f;d++)r=e[d],i=r[0],o=r[1],n=r[2],s=_.zoomReses[n],l=t._getTileName(i,o,n),a=t._tiles[l],a?a.src==c?+new Date-a._responseTime>_.tileLiveMs&&t._loadTile(a,i,o,n):t._numLoadSuccess++:(a=t._getIdleTile(),t._tiles[l]=a,t._loadTile(a,i,o,n));t._checkAllHandled()}},_onTileLoad:function(e){var t=e._layer;e._responseTime=+new Date;var a=t.options.errorTileUrl||G.Layer.Tile.EMPTY_TILE;if(e.src!==a){if("naturalWidth"in e&&!e.naturalWidth){var r=e.src;e.src=a,t._numLoadError++,t.fireEvent("tileError",{tile:e,url:r})}else{G.DomUtil.addClass(e,"g-tile-loaded"),e._loaded=!0;var i=this.options.filter;if(i){var o=G.DomUtil.create("canvas"),n=o.getContext("2d"),l=G.Browser.getCanvasRatio(),s=o.width=256*l[0],_=o.height=256*l[1];n.drawImage(e,0,0,s,_);var c=n.getImageData(0,0,s,_),d=c.data;this.canvasFilter[i](d),n.putImageData(c,0,0),e._canvas=n.canvas}t._numLoadSuccess++,t.fireEvent("tileSuccess",{tile:e,url:e.src})}t._checkAllHandled()}},_clearBgBuffer:function(){var e,t,a,r=this;for(var i in r._tiles)e=r._tiles[i],t=e._info,a=t[2],a!==r._zoom&&r._removeTile(i)}}),G.Layer.Label=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{icons:"",cluster:[],crossOrigin:"*"},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.url=e,a.options=G.Util.merge({},a.options,t),a._lts={},a._gx=a._gy=10},_initContainer:function(){var e=this;G.Layer.Graphic.prototype._initContainer.call(e)},_onAdded:function(){var e=this;e._container||e._initContainer()},_onRemoved:function(){var e=this;e._container&&e._destroyContainer()},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded()){var a=e._zoom=e._calcNearestZoom(!0),r=t.getCenter();e._clearGrids();var i=t._zoomAnim;if(i&&i._playing);else{var o=e._calcVisTileInfos(),n=e._calcTileIndex(r[0],r[1],a);e._sortTileInfos(o,n[0],n[1]),e._setLts(o)}}},_setLts:function(e){var t=this;if(e.length){for(var a,r,i,o,n,l,s=[],_=0,c=e.length;_<c;_++)i=e[_],o=i[0],n=i[1],l=i[2],a=t._getTileName(o,n,l),s.push(a),a in t._lts?(r=t._lts[a],r.loading||r.data||r.ri||t._loadLtI(o,n,l)):t._loadLtI(o,n,l),t._placeLt(a);t._dirtyTileKeys=t._dirtyTileKeys||[];for(a in t._lts)s.indexOf(a)>-1||(t._stopLoadingLt(a),t._dirtyTileKeys.push(a))}},_checkDirtyTiles:function(){var e,t=this,a=t._dirtyTileKeys;if(a&&a.length>0)for(var r=0,i=a.length;r<i;r++)e=a[r],t._removeLt(e);t._dirtyTileKeys=[]},_placeLt:function(e){var t=this,a=t._lts[e];if(a&&a._info&&a.data){var r,i,o,n,l,s,_,c,d,f,u,v,h,p,g,m,y,x,C,w,S=a.data.l;for(r in S){i=S[r],o=Number(i[0]),n=Number(i[1]),l=Number(i[2]),s=Number(i[3]),_=Number(i[4]),c=Number(i[5]),d=i[6],m=[o,n],y="imgs"+r,x=a[y];for(C in x)f=x[C],u=f[0],v=f[1],h=f[2],p=f[3],g=f[4],w=f[5],w||(f[5]=w=new G.Graphic.Point(m,null,{shape:"image",size:[v,h],offset:[p,g],image:u,imageGravity:!!d}),w.addTo(t))}}},_removeLt:function(e){var t=this,a=t._lts[e];if(a&&a._info&&a.data){t._stopLoadingLt(e);var r,i,o,n,l,s=a.data.l;for(r in s){o="imgs"+r,n=a[o];for(l in n)i=n[l],g=i[5],g&&g.remove()}delete t._lts[e]}},_loadLtI:function(e,t,a){var r=this,i=r._getTileName(e,t,a),o=r._lts[i]=r._lts[i]||{};if(o._info=[e,t,a],""!==o.data){o.loading=!0;var n=r._getTileUrl(e,t,a,{d:"i",i:G.Browser.retina?"@2x":""}),l={};r.options.crossOrigin&&(l.crossOrigin=r.options.crossOrigin);var s={responseType:"http"===n.slice(0,4).toLowerCase()?"JSONP":"JSON",header:l,success:function(e,t){o.data=t,r._processLt(i)},error:function(e){404==e.status&&(o.data="")},complete:function(){delete o.ri,o.loading=!1}};r.options.crossOrigin&&(s.responseType="JSON");var _=G.Util.ajax(n,s);o.ri=_}},_processLt:function(e){var t=this,a=t._lts[e],r=a.data;if(r){var i,o,n,l,s,_,c,d,f,u,v,h,p,g,m,y,G,x,C,w,S,D=r.l,O=r.b,L=r.i,b=r.bb,E=t.options.icons||"";for(o in D){if(i=D[o],n=Number(i[0]),l=Number(i[1]),s=i[6],O&&o in O)for(p=O[o],w=0,S=p.length;w<S;w++)g=p[w],_=g[0],c=g[1],d=g[2],f=g[3],u=g[4],v=g[5],0!=v&&b&&(G=b.slice(u,u+v),x="data:image/png;base64,"+G,C="b"+w,a["imgs"+o]=a["imgs"+o]||{},a["imgs"+o][C]=[x,_,c,d,f]);if(L&&o in L)for(m=L[o],w=0,S=m.length;w<S;w++)y=m[w],_=y[0],c=y[1],d=y[2],f=y[3],h=y[4],x=E+h,C="i"+w,a["imgs"+o]=a["imgs"+o]||{},a["imgs"+o][C]=[x,_,c,d,f]}t._checkDirtyTiles(),t._placeLt(e)}},_stopLoadingLt:function(e){var t=this._lts[e],a=G.Util.ajaxCancel;t&&(a(t.ri),t.loading=!1)},_onIconLoad:function(){this._dirtyIcons=!0},_clearGrids:function(){this._g={}},_hitGrids:function(e,t,a,r){for(var i,o=this,n=e;n<=a;n++)for(var l=t;l<=r;l++)if(i=n+","+l,o._g[i])return!0;return!1},_markGrids:function(e,t,a,r){for(var i,o=this,n=e;n<=a;n++)for(var l=t;l<=r;l++)i=n+","+l,o._g[i]=!0}}),G.Layer.VectorCache=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{cluster:[]},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.url=e,a.options=G.Util.merge({},a.options,t),a._vts={},a._visVtKeys=[],a._vIds={}},_initContainer:function(){var e=this;G.Layer.Graphic.prototype._initContainer.call(e)},_onAdded:function(){var e=this;e._container||e._initContainer()},_onRemoved:function(){var e=this;e._container&&e._destroyContainer()},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded()){var a=e._calcVisTileInfos();e._addVts(a)}},_addVts:function(e){var t=this;if(0!==e.length){var a,r,i,o,n,l,s,_,c=[];for(a=0,r=e.length;a<r;a++)n=e[a],l=n[0],s=n[1],_=n[2],i=t._getTileName(l,s,_),c.push(i),i in t._vts?(o=t._vts[i],o.data&&t._processVt(i)):t._loadVt(l,s,_);for(a=0,r=t._visVtKeys.length;a<r;a++)i=t._visVtKeys[a],c.indexOf(i)<0&&t._removeVt(i);t._visVtKeys=c}},_removeVt:function(e){var t=this,a=t._vts[e];a&&t._stopLoadingVt(e)},_loadVt:function(e,t,a){var r=this,i=r._getTileName(e,t,a),o=r._vts[i]=r._vts[i]||{};if(o._info=[e,t,a],""!==o.data){o.loading=!0;var n=r._getTileUrl(e,t,a,{d:"f"}),l={responseType:"http"===n.slice(0,4).toLowerCase()?"JSONP":"JSON",success:function(e,t){o.data=t,r._processVt(i)},error:function(e){404==e.status&&(o.data="")},complete:function(){delete o.req,o.loading=!1}},s=G.Util.ajax(n,l);o.req=s}},_processVt:function(e){for(var t,a,r,i,o,n,l,s,_,c=this,d=c._map,f=c._vts[e],u=f.data,v=u.v,h=u.s,p=G.Util.colorHex,g=0,m=v.length;g<m;g++)t=v[g],a=t.id,r=t.g,i=t.gt,o=t.st,n=h[o],l=c._vIds[a],l?l._updateGeom(r):"pt"===i?l=new G.Graphic.Point(r):"pl"===i?l=new G.Graphic.Polyline(r):"pg"===i&&(l=new G.Graphic.Polygon(r)),l&&(_=l.options,"pt"===i||"pl"===i&&(s=n.line_color,_.lineWidth=n.line_width,_.lineColor=p(s[0],s[1],s[2])),l&&(l.addTo(c),l._vtKeys=l._vtKeys||{},l._vtKeys[e]=!0,c._vIds[a]=l));d._requestRedraw()},_stopLoadingVt:function(e){var t=this._vts[e],a=G.Util.ajaxCancel;t&&(a(t.req),t.loading=!1)}}),G.Layer.FeatureService=G.Layer.Graphic.extend({mixins:[G.Layer.LOD],options:{mode:"all",vacuumCount:1e3},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.options=G.Util.merge({},a.options,t),a._reqFunc=e,a._loadingKeys={}},onSuccess:function(e){var t=this;"tile"==t.options.mode?t.fireEvent("loadTileSuccess",{extent:e}):t.fireEvent("loadAllSuccess")},onError:function(e){var t=this;"tile"==t.options.mode?t.fireEvent("loadTileError",{extent:e}):t.fireEvent("loadAllError")},onComplete:function(e){var t=this;if("tile"==t.options.mode){var a=e.join(",");delete t._loadingKeys[a],t.fireEvent("loadTileComplete",{extent:e})}else t.fireEvent("loadAllComplete")},_update:function(){var e=this,t=e._map;if(G.Layer.Graphic.prototype._update.call(e),t._isLoaded())if("tile"==e.options.mode){var a=e.count();a>e.options.vacuumCount&&e._vacuum();var r=e._calcVisTileInfos();e._addFts(r)}else e._loadAll()},_addFts:function(e){var t=this;if(0!==e.length){var a,r,i,o,n,l,s,_,c,d=t._loadingKeys,f={};for(a=0,r=e.length;a<r;a++)n=e[a],l=n[0],s=n[1],_=n[2],c=t._calcTileExtent(l,s,_),i=c.join(","),f[i]=c;for(i in d)f[i]||(o=d[i],G.Util.ajaxCancel(o),delete d[i]);for(i in f)c=f[i],t._loadFt(c)}},_loadFt:function(e){var t=this,a=e.join(","),r=t._reqFunc;if(!(a in t._loadingKeys)&&r){var i=r.call(t,e);t._loadingKeys[a]=i,t.fireEvent("loadTileStart",{extent:e})}},_loadAll:function(){var e=this,t="all",a=e._reqFunc;if(!(t in e._loadingKeys)&&a){var r=a.call(e);e._loadingKeys[t]=r,e.fireEvent("loadAllStart")}}}),G.Layer.GeoHeyFeature=G.Layer.FeatureService.extend({options:{apiKey:"",where:"1=1",outFields:"",limit:1e3},init:function(e,t){var a=this,r=function(t){var r=e+"/query",i=a.options,o={ak:i.apiKey,where:i.where,outFields:i.outFields,limit:i.limit};t&&(o.geometry=JSON.stringify(t));var n={responseType:"http"===r.slice(0,4).toLowerCase()?"JSONP":"JSON",data:o,success:function(e,r){var o=r.data,n=o.geometryType,l=o.features;if(l){var s,_,c,d,f,u,v,h,p=l.length-1,g=Math.max(0,p-i.limit),m=[];for(s=p;s>=g;s--){_=l[s],c=_.id,d=_.geom,f=_.attrs||{},"Point"==n?m.push(new G.Graphic.Point(d,f)):"Polyline"==n?m.push(new G.Graphic.Polyline(d,f)):"Polygon"==n?m.push(new G.Graphic.Polygon(d,f)):"MultiPoint"==n?m.push(new G.Graphic.MultiPoint(d,f)):"MultiPolyline"==n?m.push(new G.Graphic.MultiPolyline(d,f)):"MultiPolygon"==n&&m.push(new G.Graphic.MultiPolygon(d,f));for(v in m)h=m[v],h&&(u=c+"_"+v,a.get(u)||h.addTo(a,u))}}a.onSuccess(t)},error:function(){a.onError(t)},complete:function(){a.onComplete(t)}};G.Util.ajax(r,n)};G.Layer.FeatureService.prototype.init.call(a,r,t)}}),G.Layer.GeoHeyProgressiveFeature=G.Layer.Graphic.extend({options:{stepFactor:4,stepCount:4,tolerance:8,outFields:"[]"},init:function(e,t){var a=this;G.Layer.Graphic.prototype.init.call(a,t),a.url=e},onSuccess:function(e){this.fireEvent("extentSuccess",{extent:e})},onError:function(e){this.fireEvent("extentError",{extent:e})},onComplete:function(e){var t=this;t.fireEvent("extentComplete",{extent:e})},_update:function(){var e=this,t=e._map,a=e._loadRes=t._res,r=e._loadExtent=t.getExtent(),i=e._loadedStatus;if((!i||a!=i[0]||!G.ExtentUtil.equals(r,i[1]))&&(G.Layer.Graphic.prototype._update.call(e),t._isLoaded())){var o=e._req;o&&G.Util.ajaxCancel(o);var n,l,s=e._graphics;for(l in s)n=s[l],n._dirty=!0;e._loadStep(1)}},_loadStep:function(e){var t=this,a=t.options,r=t._loadRes,i=t._loadExtent,o=a.tolerance*Math.pow(a.stepFactor,a.stepCount-e),n=t.url+"/filter",l={responseType:"JSON",data:{extent:JSON.stringify(i),excludeExtents:JSON.stringify([]),res:r,cellPixel:o,outFields:a.outFields},success:function(a,r){t._processResult(e,r)},complete:function(){t._req=null}};t._req=G.Util.ajax(n,l)},_processResult:function(e,t){var a=this,r=a.options,i=a._loadRes,o=a._loadExtent,n=r.tolerance*Math.pow(r.stepFactor,r.stepCount-e),l=i*n,s=t.geometryType,_=t.features;if(!_)return a.onError(o),void a.onComplete(o);var c,d,f,u,v,h,p,g,m=_.length-1;for(c=m;c>=0;c--)if(d=_[c],f=d.id,u=d.geom,v=d.attrs||{},"Point"==s)g=new G.Graphic.Point(u,v),a._updateGraphic(l,f,0,g);else if("Polyline"==s)g=new G.Graphic.Polyline(u,v),a._updateGraphic(l,f,0,g);else if("Polygon"==s)g=new G.Graphic.Polygon(u,v),a._updateGraphic(l,f,0,g);else if("MultiPoint"==s)for(h in u.multi)p=u.multi[h],g=new G.Graphic.Point(p,v),a._updateGraphic(l,f,h,g);else if("MultiPolyline"==s)for(h in u.multi)p=u.multi[h],g=new G.Graphic.Polyline(p,v),a._updateGraphic(l,f,h,g);else if("MultiPolygon"==s)for(h in u.multi)p=u.multi[h],g=new G.Graphic.Polygon(p,v),a._updateGraphic(l,f,h,g);e<r.stepCount?a._loadStep(e+1):(a._clearDirty(),a._loadedStatus=[i,o],a.onSuccess(o),a.onComplete(o))},_updateGraphic:function(e,t,a,r){var i=this,o=t+(a?"_"+a:""),n=i.get(o);n?(e<n._res&&(n.updateGeom(r.geom,!0),n._res=e),n._dirty=!1):(r._res=e,r.addTo(i,o))},_clearDirty:function(){var e,t,a=this,r=a._graphics;for(t in r)e=r[t],e._dirty&&e.remove()}}),G.Layer.TiledService=G.Layer.extend({mixins:[G.Layer.LOD],init:function(e,t){var a=this;a.options=G.Util.merge({},a.options,t),a._reqFunc=e,a._loadingKeys={},a._loadedKeys={}},onSuccess:function(e,t){var a=this;a._numLoadSuccess++;var r=parseInt(e[0]),i=parseInt(e[1]),o=parseInt(e[2]),n=a._getTileName(r,i,o);a._loadedKeys[n]=e,a.fireEvent("loadTileSuccess",{tileInfo:e,data:t})},onError:function(e){var t=this;t._numLoadError++,t.fireEvent("loadTileError",{tileInfo:e})},onComplete:function(e){var t=this,a=parseInt(e[0]),r=parseInt(e[1]),i=parseInt(e[2]),o=t._getTileName(a,r,i);delete t._loadingKeys[o],t.fireEvent("loadTileComplete",{tileInfo:e}),t._checkAllHandled()},_update:function(){var e=this,t=e._map;if(t._isLoaded()){var a,r,i,o,n,l,s,_=e._calcVisTileInfos(),c={};for(a=0,r=_.length;a<r;a++)o=_[a],n=o[0],l=o[1],s=o[2],i=e._getTileName(n,l,s),c[i]=o;e._addTiles(c);for(i in e._loadedKeys)c[i]||(o=e._loadedKeys[i],delete e._loadedKeys[i],e.fireEvent("unusedTile",{tileInfo:o}));e._onUpdated()}},_addTiles:function(e){var t,a,r,i=this,o=i._loadingKeys;for(t in o)e[t]||(a=o[t],G.Util.ajaxCancel(a),delete o[t]);i._numLoad=Object.keys(e).length,i._numLoadSuccess=0,i._numLoadError=0;for(t in e)r=e[t],i._loadTile(r);i._checkAllHandled()},_loadTile:function(e){var t=this,a=t._reqFunc,r=parseInt(e[0]),i=parseInt(e[1]),o=parseInt(e[2]),n=t._getTileName(r,i,o);if(!(n in t._loadingKeys)&&a){if(n in t._loadedKeys)return void t._numLoadSuccess++;var l=a.call(t,r,i,o);l&&(t._loadingKeys[n]=l,t.fireEvent("loadTileStart",{tileInfo:e}))}},_stopLoadingByKey:function(e){var t=this._loadingKeys,a=t[e];a&&(G.Util.ajaxCancel(a),delete t[e])},_checkAllHandled:function(){var e=this;e._numLoad==e._numLoadSuccess+e._numLoadError&&e.fireEvent("allLoaded")},_onUpdated:function(){}}),G.Layer.UTFGrid=G.Layer.TiledService.extend({mixins:[G.Layer.LOD],options:{showAttr:!0,pos:"right"},init:function(e,t){var a=this;a.url=e,a.options=G.Util.merge({},a.options,t),a._tiles={},a._dirtyTiles={};var r=function(e,t,r){var i,o=a._getTileName(e,t,r),n=a._getTileUrl(e,t,r),l=[e,t,r];G.Util.ajax(n,{responseType:"jsonp",success:function(e,t){return a.onSuccess(l,t),!(!(t&&t.data&&t.data.keys)||1==t.data.keys.length&&""==t.data.keys[0])&&(a._tiles[o]=t.data,i=a._map,void(i&&i._requestRedraw()))},error:function(e){a.onError(l)},complete:function(e){a.onComplete(l)}})};a._pos="left"==a.options.pos?-1:0,G.Layer.TiledService.prototype.init.call(a,r,a.options)},_onAdded:function(){var e=this,t=e._map;if(e.options.showAttr){var a=t._layersFrame;e._board=document.createElement("div"),e._board.style.display="none",e._board.className="g-utf-board",a.appendChild(e._board)}t.addListener("mousemove",e._onMouseMove,e),e.addListener("unusedTile",e._onUnusedTile,e)},_onRemoved:function(){var e=this,t=e._map;e._board&&e._board.parentNode&&e._board.parentNode.removeChild(e._board),t.removeListener("mousemove",e._onMouseMove,e),e.removeListener("unusedTile",e._onUnusedTile,e)},_onMouseMove:function(e){var t=this,a=t._map;if(t.isVisible()){var r=a._res,i=(e.mapX-t.options.originX)/r,o=(t.options.originY-e.mapY)/r,n=t._calcNearestZoom(),l=t._calcTileExtent(0,0,n),s=(l[2]-l[0])/r,_=s/256,c=4*_,d=Math.floor(i/s),f=Math.floor(o/s),u=Math.floor((i-d*s)/c),v=Math.floor((o-f*s)/c),h=[d,f,n],p=t.getData(h,u,v),g=[e.screenX,e.screenY];t.options.showAttr&&t.showData(p,g),t.fireEvent("gridMouseMove",{data:p,point:g})}},_onUnusedTile:function(e){var t=this,a=e.tileInfo,r=t._getTileName(a[0],a[1],a[2]);delete t._tiles[r]},getData:function(e,t,a){var r=this,i=r._getTileName(e[0],e[1],e[2]),o=r._tiles[i];if(o&&o.grid){var n=this._decode(o.grid[a].charCodeAt(t));return i=o.keys[n],o.data[i]}},_decode:function(e){return e>=93&&e--,e>=35&&e--,e-32},showData:function(e,t){var a=this,r=G.DomUtil;if(e){var i="";for(var o in e)"_id"!==o&&(i+='<div><span class="g-utf-board-key">'+o+": </span><span>"+e[o]+"</span></div>");var n=a._board.clientHeight,l=a._board.clientWidth;a._board.innerHTML=i;var s=t[0]+(l+30)*a._pos+15,_=t[1]-n/2;r.markPosTransform(a._board,s,_),r.updateTransform(a._board),a._board.style.display="block"}else a._board.style.display="none"}}),G.Graphic.Arrow=G.Graphic.Arrow.extend({_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx;e._updateGeomDraw(r._res);var o,n,l,s=e._geomDraw,_=r._canvasOffset,c=e.bbox,d=(c[0]+c[2])/2,f=(c[1]+c[3])/2,u=r._calcWrapPointRange([d,f])||[0,0],v=r.options.maxExtent,h=v[2]-v[0];i.save();for(var p=u[0];p<=u[1];p++){i.beginPath();for(var g=0,m=s.length;g<m;g++){n=s[g];for(var y=0,x=n.length;y<x;y++)l=n[y],l=r.toScreen([l[0]+p*h,l[1]]),o=0===y?"moveTo":"lineTo",i[o](l[0]+_[0],l[1]+_[1]);l=n[0],l=r.toScreen([l[0]+p*h,l[1]]),i.lineTo(l[0]+_[0],l[1]+_[1])}if(t.fill){if(t.fillImage){var C=G.Browser.getImageSrc(t.fillImage),w=G.DomUtil.getImgElement(C,function(){r._requestRedraw()},null,"*");w._loaded?(i.fillStyle=i.createPattern(w,"repeat"),i.globalAlpha=t.fillOpacity):i.globalAlpha=0}else i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity;i.fill()}(t.outline||e._mouseOver||e._editing)&&(i.strokeStyle=e._editing?t.lineHighlightColor:t.outline?t.outlineColor:t.fillColor,i.lineCap=t.outlineCap,i.lineJoin=t.outlineJoin,i.lineWidth=(t.outline?t.outlineWidth:0)+(e._mouseOver?t.lineHighlightWiden:0),i.globalAlpha=t.outlineOpacity,G.Util.setCanvasLineDash(i,t.outlineDashArray),i.stroke())}i.restore()},_drawMask:function(){var e=this,t=e._map,a=t._maskCtx;e._updateGeomDraw(t._res);var r,i,o,n=e._geomDraw,l=t._canvasOffset,s=e.bbox,_=(s[0]+s[2])/2,c=(s[1]+s[3])/2,d=t._calcWrapPointRange([_,c])||[0,0],f=t.options.maxExtent,u=f[2]-f[0];a.beginPath();for(var v=d[0];v<=d[1];v++)for(var h=0,p=n.length;h<p;h++){i=n[h];for(var g=0,m=i.length;g<m;g++)o=i[g],o=t.toScreen([o[0]+v*u,o[1]]),r=0===g?"moveTo":"lineTo",a[r](o[0]+l[0],o[1]+l[1]);o=i[0],o=t.toScreen([o[0]+v*u,o[1]]),a.lineTo(o[0]+l[0],o[1]+l[1])}a.fill()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Circle=G.Graphic.Circle.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=r._res,n=e.geom,l=n[0],s=n[1],_=n[2],c=_/o,d=r._canvasOffset,f=r._calcWrapPointRange(n)||[0,0],u=r.options.maxExtent,v=u[2]-u[0];i.save();for(var h=f[0];h<=f[1];h++){var p=r.toScreen([l+h*v,s]);if(p[0]+=d[0],p[1]+=d[1],i.beginPath(),i.arc(p[0],p[1],c,0,2*Math.PI),t.fill){if(t.fillImage){var g=G.Browser.getImageSrc(t.fillImage),m=G.DomUtil.getImgElement(g,function(){r._requestRedraw()},null,"*");m._loaded?(i.fillStyle=i.createPattern(m,"repeat"),i.globalAlpha=t.fillOpacity):i.globalAlpha=0}else if(t.gradual){var y=i.createRadialGradient(p[0],p[1],0,p[0],p[1],c),x=G.Util.colorRgb(t.fillColor);y.addColorStop(0,t.fillColor),y.addColorStop(1,"rgba("+x[0]+","+x[1]+","+x[2]+","+t.fillOpacity+")"),i.fillStyle=y}else i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity;i.fill()}(t.outline||e._mouseOver)&&(i.strokeStyle=e._editing?t.lineHighlightColor:t.outlineColor,i.lineWidth=e._mouseOver?t.outlineWidth+t.lineHighlightWiden:t.outlineWidth,i.globalAlpha=t.outlineOpacity,G.Util.setCanvasLineDash(i,t.outlineDashArray),i.stroke())}i.restore()},_drawMask:function(){var e=this,t=e._map,a=t._maskCtx,r=t._res,i=e.geom,o=i[0],n=i[1],l=i[2],s=l/r,_=t._canvasOffset,c=t._calcWrapPointRange(i)||[0,0],d=t.options.maxExtent,f=d[2]-d[0];a.beginPath();for(var u=c[0];u<=c[1];u++){var v=t.toScreen([o+u*f,n]);v[0]+=_[0],v[1]+=_[1],a.arc(v[0],v[1],s,0,2*Math.PI,!1)}a.fill()},_onStartEdit:function(){var e=this,t=e._layer,a=t._map,r=e.virtualMouse;for(var i in r.DOWN)a.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(var r in a.DOWN)t.removeListener(a.DOWN[r],e._onVertexDragStart,e);e._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Group=G.Graphic.Group.extend({_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.MultiPoint=G.Graphic.MultiPoint.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=Math.round,n=t.shape,l=t.size,s=l[0],_=l[1],c=t.offset,d=t.imageRotate;t.imageGravity||(d+=r._rotate),"image"==n&&d&&(c=G.MathUtil.rotateVector(c,d));for(var f,u,v,h=e.geom.m,p=r._canvasOffset,g=e.bbox,m=(g[0]+g[2])/2,y=(g[1]+g[3])/2,x=r._calcWrapPointRange([m,y])||[0,0],C=r.options.maxExtent,w=C[2]-C[0],S=x[0];S<=x[1];S++)for(var D=0;D<h.length;D++)if(f=h[D],f=r.toScreen([f[0]+S*w,f[1]]),u=f[0]+c[0]+p[0],v=f[1]+c[1]+p[1],"rect"==n)i.beginPath(),i.rect(u-s/2,v-_/2,s,_),e._renderPath(u,v,Math.max(s/2,_/2));else if("image"==n){var O=G.Browser.getImageSrc(t.image),L=G.DomUtil.getImgElement(O,function(){r._requestRedraw()});L._loaded&&(i.save(),i.translate(o(u),o(v)),i.rotate(d/G.MathUtil.DEGREE_PER_RADIAN),i.drawImage(L,0,0,s,_),i.restore())}else if("text"==n){i.save(),i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity,i.font=t.textStyle+" "+s+"px "+t.textFont,i.textAlign=t.textAlign,i.textBaseline="middle";var b=t.text;if(!e._textMeasureWidth||e._textMeasure!=b){var E=i.measureText(b);e._textMeasureWidth=E.width,e._textMeasure=b}i.fillText(b,u,v),i.restore()}else i.beginPath(),i.arc(u,v,s/2,0,2*Math.PI),e._renderPath(u,v,s/2)},_renderPath:function(e,t,a){var r,i,o=this,n=o._layer,l=n._map,s=n._ctx,_=o.options;if(s.save(),_.fill){if(_.fillImage)r=G.Browser.getimgSrc(_.fillImage),i=G.DomUtil.getImgElement(r,function(){l._requestRedraw()}),i._loaded?(s.fillStyle=s.createPattern(i,"repeat"),s.globalAlpha=_.fillOpacity):s.globalAlpha=0;else if(_.gradual){var c=s.createRadialGradient(e,t,0,e,t,a),d=G.Util.colorRgb(_.fillColor);c.addColorStop(0,_.fillColor),c.addColorStop(1,"rgba("+d[0]+","+d[1]+","+d[2]+","+_.fillOpacity+")"),s.fillStyle=c}else s.fillStyle=_.fillColor,s.globalAlpha=_.fillOpacity;s.fill()}(_.outline||o._mouseOver||o._editing)&&(s.strokeStyle=o._editing?_.lineHighlightColor:_.outline?_.outlineColor:_.fillColor,s.lineWidth=o._mouseOver?_.outlineWidth+_.lineHighlightWiden:_.outlineWidth,s.globalAlpha=_.outlineOpacity,G.Util.setCanvasLineDash(s,_.outlineDashArray),s.stroke()),s.restore()},_onStartEdit:function(){var e=this,t=e._layer,a=t._map,r=e.virtualMouse;for(var i in r.DOWN)a.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(var r in a.DOWN)t.removeListener(a.DOWN[r],e._onVertexDragStart,e);e._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging&&!e.options.allowPan,a._requestRedraw(),e._isVertex?r.addClass(a._layersFrame,"g-edit"):r.addClass(a._layersFrame,"g-clickable")}},_onMouseOut:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging,a._requestRedraw(),e._isVertex?r.removeClass(a._layersFrame,"g-edit"):r.removeClass(a._layersFrame,"g-clickable")}}}),G.Graphic.MultiPolygon=G.Graphic.MultiPolygon.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a,r,i=this,o=i.options,n=i._layer,l=n._map,s=n._ctx,_=i.geom.m,c=l._canvasOffset,d=i.bbox,f=(d[0]+d[2])/2,u=(d[1]+d[3])/2,v=l._calcWrapPointRange([f,u])||[0,0],h=l.options.maxExtent,p=h[2]-h[0];s.save(),s.beginPath();for(var g=v[0];g<=v[1];g++)for(var m=0,y=_.length;m<y;m++){e=_[m];for(var x=0,C=e.length;x<C;x++){a=e[x];for(var w=0,S=a.length;w<S;w++)r=a[w],r=l.toScreen([r[0]+g*p,r[1]]),t=0===w?"moveTo":"lineTo",s[t](r[0]+c[0],r[1]+c[1]);r=a[0],r=l.toScreen([r[0]+g*p,r[1]]),s.lineTo(r[0]+c[0],r[1]+c[1])}}if(o.fill){if(o.fillImage){var D=G.Browser.getImageSrc(o.fillImage),O=G.DomUtil.getImgElement(D,function(){l._requestRedraw()},null,"*");O._loaded?(s.fillStyle=s.createPattern(O,"repeat"),s.globalAlpha=o.fillOpacity):s.globalAlpha=0}else s.fillStyle=o.fillColor,s.globalAlpha=o.fillOpacity;s.fill()}(o.outline||i._mouseOver||i._editing)&&(s.strokeStyle=i._editing?o.lineHighlightColor:o.outline?o.outlineColor:o.fillColor,s.lineCap=o.outlineCap,s.lineJoin=o.outlineJoin,s.lineWidth=(o.outline?o.outlineWidth:0)+(i._mouseOver?o.lineHighlightWiden:0),s.globalAlpha=o.outlineOpacity,G.Util.setCanvasLineDash(s,o.outlineDashArray),s.stroke()),s.restore()},_drawMask:function(){var e,t,a,r,i=this,o=i._map,n=o._maskCtx,l=i.geom.m,s=o._canvasOffset,_=i.bbox,c=(_[0]+_[2])/2,d=(_[1]+_[3])/2,f=o._calcWrapPointRange([c,d])||[0,0],u=o.options.maxExtent,v=u[2]-u[0];n.beginPath();for(var h=f[0];h<=f[1];h++)for(var p=0,g=l.length;p<g;p++){e=l[p];for(var m=0,y=e.length;m<y;m++){a=e[m];for(var G=0,x=a.length;G<x;G++)r=a[G],r=o.toScreen([r[0]+h*v,r[1]]),t=0===G?"moveTo":"lineTo",n[t](r[0]+s[0],r[1]+s[1]);r=a[0],r=o.toScreen([r[0]+h*v,r[1]]),n.lineTo(r[0]+s[0],r[1]+s[1])}}n.fill()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);
e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.MultiPolyline=G.Graphic.MultiPolyline.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a,r=this,i=r.options,o=r._layer,n=o._map,l=o._ctx,s=r.geom.m,_=n._canvasOffset,c=r.bbox,d=(c[0]+c[2])/2,f=(c[1]+c[3])/2,u=n._calcWrapPointRange([d,f])||[0,0],v=n.options.maxExtent,h=v[2]-v[0];l.save(),l.beginPath();for(var p=u[0];p<=u[1];p++)for(var g=0,m=s.length;g<m;g++){e=s[g];for(var y=0,x=e.length;y<x;y++)a=e[y],a=n.toScreen([a[0]+p*h,a[1]]),t=0===y?"moveTo":"lineTo",l[t](a[0]+_[0],a[1]+_[1])}l.strokeStyle=r._editing?i.lineHighlightColor:i.lineColor,l.lineCap=i.lineCap,l.lineJoin=i.lineJoin,l.lineWidth=r._mouseOver?i.lineWidth+i.lineHighlightWiden:i.lineWidth,l.globalAlpha=i.lineOpacity,G.Util.setCanvasLineDash(l,i.lineDashArray),l.stroke(),l.restore()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.OD=G.Graphic.OD.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=e.geom,n=e._mpt,l=r._canvasOffset,s=e.bbox,_=(s[0]+s[2])/2,c=(s[1]+s[3])/2,d=r._calcWrapPointRange([_,c])||[0,0],f=r.options.maxExtent,u=f[2]-f[0];i.save(),i.strokeStyle=e._editing?t.lineHighlightColor:t.lineColor,i.lineCap=t.lineCap,i.lineJoin=t.lineJoin,i.lineWidth=e._mouseOver?t.lineWidth+t.lineHighlightWiden:t.lineWidth,i.globalAlpha=t.lineOpacity,i.shadowBlur=1==t.shadow?4:0,i.shadowColor=1==t.shadow?t.shadowColor:"",G.Util.setCanvasLineDash(i,e.options.lineDashArray),i.beginPath();for(var v=(e._toGraphic?e._toGraphic._arrowctx:e._arrowctx,d[0]);v<=d[1];v++){var h=t.animating,p=h?t.endGeom:o[1],g=0;g=p[0]!=o[0][0]?h?(o[1][0]-o[0][0])/(p[0]-o[0][0]):1:h?(o[1][1]-o[0][1])/(p[1]-o[0][1]):1;var m,y,x,C,w,S,D,O=r.toScreen([o[0][0]+v*u,o[0][1]]),n=r.toScreen([n[0]+v*u,n[1]]),L=r.toScreen([p[0]+v*u,p[1]]);C=e._getQuadraticBezierTangent(0,O,n,L),w=e._getQuadraticBezierTangent(g,O,n,L),S=G.MathUtil.calcTheta(C[0],C[1]),D=G.MathUtil.calcTheta(w[0],w[1]),m=O,x=e._getQuadraticBezierPoint(g,O,n,L);var b=Math.tan(S),E=Math.tan(D),R=m[1]-b*m[0],T=x[1]-E*x[0],P=(R-T)/(E-b),M=b*P+R;y=[P,M],e.options.symbol&&e.options.symbolOnly||(i.moveTo(m[0]+l[0],m[1]+l[1]),i.quadraticCurveTo(y[0]+l[0],y[1]+l[1],x[0]+l[0],x[1]+l[1])),i.stroke(),i.restore(),e.options.symbol&&e._drawSymbol(i,[x[0]+l[0],x[1]+l[1]],D)}},_onMouseOver:function(){var e=this,t=e._layer._map;t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map;t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")},_onStartEdit:function(){return this._editing=!1,!1},_drawSymbol:function(e,t,a){var r=this,i=r.options.symbol,o=r.options.symbolSize;if("arrow"===i){var n=a/Math.PI*180+90;o=o>10?10:o<4?4:o;var l=[o,2*o],s=[0,o],_=[-o,2*o];l=G.MathUtil.rotateVector(l,n),s=G.MathUtil.rotateVector(s,n),_=G.MathUtil.rotateVector(_,n),e.save(),e.strokeStyle=e.fillStyle=G.Util.isArray(r.options.lineColor)?r.options.lineColor[1]:r.options.lineColor,e.lineJoin="round",e.beginPath(),e.moveTo(t[0],t[1]),e.lineTo(t[0]+l[0],t[1]+l[1]),e.lineTo(t[0]+s[0],t[1]+s[1]),e.lineTo(t[0]+_[0],t[1]+_[1]),e.closePath(),e.fill(),e.stroke(),e.restore()}else if("point"===i){var c=r.options.lineWidth/2;c=c>1?c:1,e.save(),e.beginPath(),e.strokeStyle="#fff",e.arc(t[0],t[1],c,0,2*Math.PI),e.stroke(),e.restore()}}}),G.Graphic.Point=G.Graphic.Point.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e=this,t=e.options,a=e._layer,r=a._map,i=a._ctx,o=Math.round,n=t.shape,l=t.size,s=l[0],_=l[1],c=t.offset,d=t.imageRotate;t.imageGravity||(d+=r._rotate),"image"==n&&d&&(c=G.MathUtil.rotateVector(c,d));for(var f=e.geom[0],u=e.geom[1],v=r._canvasOffset,h=r._calcWrapPointRange(e.geom)||[0,0],p=r.options.maxExtent,g=p[2]-p[0],m=h[0];m<=h[1];m++){var y=r.toScreen([f+m*g,u]),x=y[0]+c[0],C=y[1]+c[1];if(x+=v[0],C+=v[1],"rect"==n)i.beginPath(),i.rect(x-s/2,C-_/2,s,_),e._renderPath(x,C,Math.max(s/2,_/2));else if("image"==n){var w=G.Browser.getImageSrc(t.image),S=G.DomUtil.getImgElement(w,function(){r._requestRedraw()});S._loaded&&(i.save(),i.translate(o(x),o(C)),i.rotate(d/G.MathUtil.DEGREE_PER_RADIAN),i.drawImage(S,0,0,s,_),i.restore())}else if("text"==n){i.save(),i.fillStyle=t.fillColor,i.globalAlpha=t.fillOpacity,i.font=t.textStyle+" "+s+"px "+t.textFont,i.textAlign=t.textAlign,i.textBaseline="middle";var D=t.text;if(!e._textMeasureWidth||e._textMeasure!=D){var O=i.measureText(D);e._textMeasureWidth=O.width,e._textMeasure=D}i.fillText(D,x,C),i.restore()}else i.beginPath(),i.arc(x,C,s/2,0,2*Math.PI),e._renderPath(x,C,s/2)}},_renderPath:function(e,t,a){var r,i,o=this,n=o._layer,l=n._map,s=n._ctx,_=o.options;if(s.save(),_.fill){if(_.fillImage)r=G.Browser.getimgSrc(_.fillImage),i=G.DomUtil.getImgElement(r,function(){l._requestRedraw()}),i._loaded?(s.fillStyle=s.createPattern(i,"repeat"),s.globalAlpha=_.fillOpacity):s.globalAlpha=0;else if(_.gradual){var c=s.createRadialGradient(e,t,0,e,t,a),d=G.Util.colorRgb(_.fillColor);c.addColorStop(0,_.fillColor),c.addColorStop(1,"rgba("+d[0]+","+d[1]+","+d[2]+","+_.fillOpacity+")"),s.fillStyle=c}else s.fillStyle=_.fillColor,s.globalAlpha=_.fillOpacity;s.fill()}(_.outline||o._mouseOver||o._editing)&&(s.strokeStyle=o._editing?_.lineHighlightColor:_.outline?_.outlineColor:_.fillColor,s.lineWidth=o._mouseOver?_.outlineWidth+_.lineHighlightWiden:_.outlineWidth,s.globalAlpha=_.outlineOpacity,G.Util.setCanvasLineDash(s,_.outlineDashArray),s.stroke()),s.restore()},_onStartEdit:function(){var e=this,t=e._layer,a=t._map,r=e.virtualMouse;for(var i in r.DOWN)a.addListener(r.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(var r in a.DOWN)t.removeListener(a.DOWN[r],e._onVertexDragStart,e);e._removeVertexes()},_onMouseOver:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging&&!e.options.allowPan,a._requestRedraw(),e._isVertex?r.addClass(a._layersFrame,"g-edit"):r.addClass(a._layersFrame,"g-clickable")}},_onMouseOut:function(){var e=this,t=e._layer;if(t){var a=t._map,r=G.DomUtil,i=a._handlers.Drag;i&&!i._dragging,a._requestRedraw(),e._isVertex?r.removeClass(a._layersFrame,"g-edit"):r.removeClass(a._layersFrame,"g-clickable")}}}),G.Graphic.Polygon=G.Graphic.Polygon.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a,r=this,i=r.options,o=r._layer,n=o._map,l=o._ctx,s=r.geom,_=n._canvasOffset,c=r.bbox,d=(c[0]+c[2])/2,f=(c[1]+c[3])/2,u=n._calcWrapPointRange([d,f])||[0,0],v=n.options.maxExtent,h=v[2]-v[0];l.save();for(var p=u[0];p<=u[1];p++){l.beginPath();for(var g=0,m=s.length;g<m;g++){t=s[g];for(var y=0,x=t.length;y<x;y++)a=t[y],a=n.toScreen([a[0]+p*h,a[1]]),e=0===y?"moveTo":"lineTo",l[e](a[0]+_[0],a[1]+_[1]);a=t[0],a=n.toScreen([a[0]+p*h,a[1]]),l.lineTo(a[0]+_[0],a[1]+_[1])}if(i.fill){if(i.fillImage){var C=G.Browser.getImageSrc(i.fillImage),w=G.DomUtil.getImgElement(C,function(){n._requestRedraw()},null,"*");w._loaded?(l.fillStyle=l.createPattern(w,"repeat"),l.globalAlpha=i.fillOpacity):l.globalAlpha=0}else l.fillStyle=i.fillColor,l.globalAlpha=i.fillOpacity;l.fill()}(i.outline||r._mouseOver||r._editing)&&(l.strokeStyle=r._editing?i.lineHighlightColor:i.outline?i.outlineColor:i.fillColor,l.lineCap=i.outlineCap,l.lineJoin=i.outlineJoin,l.lineWidth=(i.outline?i.outlineWidth:0)+(r._mouseOver?i.lineHighlightWiden:0),l.globalAlpha=i.outlineOpacity,G.Util.setCanvasLineDash(l,i.outlineDashArray),l.stroke())}l.restore()},_drawMask:function(){var e,t,a,r=this,i=r._map,o=i._maskCtx,n=r.geom,l=i._canvasOffset,s=r.bbox,_=(s[0]+s[2])/2,c=(s[1]+s[3])/2,d=i._calcWrapPointRange([_,c])||[0,0],f=i.options.maxExtent,u=f[2]-f[0];o.beginPath();for(var v=d[0];v<=d[1];v++)for(var h=0,p=n.length;h<p;h++){t=n[h];for(var g=0,m=t.length;g<m;g++)a=t[g],a=i.toScreen([a[0]+v*u,a[1]]),e=0===g?"moveTo":"lineTo",o[e](a[0]+l[0],a[1]+l[1]);a=t[0],a=i.toScreen([a[0]+v*u,a[1]]),o.lineTo(a[0]+l[0],a[1]+l[1])}o.fill()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Graphic.Polyline=G.Graphic.Polyline.extend({_onAdded:function(){var e=this._layer._map;e&&e._requestRedraw()},_onRemoved:function(){var e=this._layer._map;e&&e._requestRedraw()},_draw:function(){var e,t,a=this,r=a.options,i=a._layer,o=i._map,n=i._ctx,l=a.geom,s=o._canvasOffset,_=a.bbox,c=(_[0]+_[2])/2,d=(_[1]+_[3])/2,f=o._calcWrapPointRange([c,d])||[0,0],u=o.options.maxExtent,v=u[2]-u[0];n.save();for(var h=f[0];h<=f[1];h++){n.beginPath();for(var p=0;p<l.length;p++)t=l[p],t=o.toScreen([t[0]+h*v,t[1]]),e=0===p?"moveTo":"lineTo",n[e](t[0]+s[0],t[1]+s[1]);n.strokeStyle=a._editing?r.lineHighlightColor:r.lineColor,n.lineCap=r.lineCap,n.lineJoin=r.lineJoin,n.lineWidth=a._mouseOver?r.lineWidth+r.lineHighlightWiden:r.lineWidth,n.globalAlpha=r.lineOpacity,G.Util.setCanvasLineDash(n,r.lineDashArray),n.stroke()}n.restore()},_onStartEdit:function(){var e=this,t=e._layer._map,a=e.virtualMouse;for(i in a.DOWN)t.addListener(a.DOWN[i],e._onVertexDragStart,e);e._refreshVertexes()},_onEndEdit:function(){var e,t,a=this,r=a._layer._map,i=a.virtualMouse;for(e in i.DOWN)t=i.DOWN[e],r.removeListener(t,a._onVertexDragStart,a),r.removeListener(i.MOVE[t],a._onVertexDrag,a),r.removeListener(i.UP[t],a._onVertexDragEnd,a);a._removeVertexes(),G.DomUtil.removeClass(r._layersFrame,"g-edit"),r._requestRedraw()},_onMouseOver:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging&&!e.options.allowPan,t._requestRedraw(),G.DomUtil.addClass(t._layersFrame,"g-clickable")},_onMouseOut:function(){var e=this,t=e._layer._map,a=t._handlers.Drag;a&&!a._dragging,t._requestRedraw(),G.DomUtil.removeClass(t._layersFrame,"g-clickable")}}),G.Map=G.Map.extend({print:function(e,t){var a=this,r=G.DomUtil,i=G.Browser.getCanvasRatio(),o=a.getSize(),n=o[0],l=o[1],s=e||n,_=t||l,c=s/n,d=_/l,f=Math.max(c,d),u=a._onScreenCtx.canvas,v=u.width/i[0],h=u.height/i[1],p=r.create("canvas");return p.width=s,p.height=_,p.getContext("2d").drawImage(u,(s-v*f)/2,(_-h*f)/2,v*f,h*f),p.toDataURL()},_initAddition:function(){var e=this,t=G.DomUtil,a=e._useOffScreen=!window.G_OFF_CANVAS_OFFSCREEN;e._onScreenCtx=t.create("canvas","g-layer",e._layersFrame).getContext("2d"),a&&(e._offScreenCtx=t.create("canvas").getContext("2d")),e._snapshotCtx=t.create("canvas").getContext("2d"),e._maskCtx=t.create("canvas").getContext("2d"),e._mode="canvas"},_redrawSnapshot:function(e,t,a){var r,i,o,n,l,s,_,c=this,d=G.Browser.getCanvasRatio(),f=c._onScreenCtx.canvas,u=f.width/(d[0]||1),v=f.height/(d[1]||1),h=G.Browser.getPxRatio(),p=h[0],g=h[1],m=c._center,y=c._rotate,x=c._res,C=y-t,w=x/a,S=c._onScreenCtx;r=-u/2,i=-v/2,t&&(o=G.MathUtil.rotateVector([r,i],-t),r=o[0],i=o[1]),n=r*a*p+e[0],l=-i*a*g+e[1],r=(n-m[0])/x/p,i=-(l-m[1])/x/g,y&&(o=G.MathUtil.rotateVector([r,i],y),r=o[0],i=o[1]),s=u/2+r,_=v/2+i,c._clearCanvas(S),S.save(),S.translate(s,_),S.rotate(C/G.MathUtil.DEGREE_PER_RADIAN),S.drawImage(c._snapshotCtx.canvas,0,0,u/w,v/w),S.restore()},_redraw:function(){var e=this,t=e._useOffScreen,a=e._onScreenCtx.canvas,r=e._zoomAnim,i=e._rotateAnim,o=e._handlers.Pinch;if(!e.options.canvasAnimRedraw&&r&&r._playing)return void e._redrawSnapshot(r._startCenter,e._rotate,r._startRes);if(!e.options.canvasAnimRedraw&&i&&i._playing)return void e._redrawSnapshot(e._center,i._startRotate,e._res);if(!e.options.canvasAnimRedraw&&o&&o._pinching)return void e._redrawSnapshot(o._startCenter,o._startRotate,o._startRes);t?e._clearCanvas(e._offScreenCtx):e._clearCanvas(e._onScreenCtx);var n,l,s;for(n in e._layerOrder)l=e._layerOrder[n],s=e._layers[l],s&&s.isVisible()&&s._draw();if(e._drawMask(),t){ratio=G.Browser.getCanvasRatio(),w=a.width/(ratio[0]||1),h=a.height/(ratio[1]||1);try{e._clearCanvas(e._onScreenCtx),e._onScreenCtx.drawImage(e._offScreenCtx.canvas,0,0,w,h)}catch(_){}}try{e._onScreenCtx.drawImage(e._maskCtx.canvas,0,0)}catch(_){}e.fireEvent("redraw")},_update:function(){var e,t,a,r=this,i=r._useOffScreen,o=r._onScreenCtx.canvas;i?r._clearCanvas(r._offScreenCtx):r._clearCanvas(r._onScreenCtx);var n,l,s;for(n in r._layerOrder)l=r._layerOrder[n],s=r._layers[l],s&&s.isVisible()&&s._update();if(r._drawMask(),i){e=G.Browser.getCanvasRatio(),t=o.width/(e[0]||1),a=o.height/(e[1]||1);try{r._clearCanvas(r._onScreenCtx),r._onScreenCtx.drawImage(r._offScreenCtx.canvas,0,0,t,a)}catch(_){}}try{r._onScreenCtx.drawImage(r._maskCtx.canvas,0,0)}catch(_){}r.fireEvent("update")},_drawMask:function(){var e,t,a=this,r=a._maskCtx,i=a.options,o=a._masks;if(o){var n=o.length;if(i.mask){if(a._clearCanvas(a._maskCtx),0==n)return;for(r.save(),r.globalCompositeOperation="source-over",r.fillStyle=i.maskColor,r.globalAlpha=i.maskOpacity,r.fillRect(0,0,r.canvas.width,r.canvas.height),r.globalCompositeOperation="destination-out",r.globalAlpha=1,e=0;e<n;e++)t=o[e],t._drawMask&&t._drawMask();r.restore()}}},_onResize:function(){var e=this;e._resizeCanvases(),e._updateDrawSize(),e._requestUpdate()},_clearCanvas:function(e){var t=e.canvas,a=Math.ceil,r=a(t.width),i=a(t.height);e.clearRect(0,0,r,i);var o=G.Browser;if(o.webkit533||o.webkit534){var n=t.style,l=n.display;n.display="none",t.offsetHeight,n.display=l}},_resizeCanvas:function(e,t,a,r){if(e&&t&&a){var i=this,o=e.canvas,n=r?r[0]||1:1,l=r?r[1]||1:1,s=i.options.canvasExpandFactor,_=t*s,c=a*s,d=t+2*_,f=a+2*c;G.DomUtil.setPosition(o,-_,-c),1==n&&1==l?(o.width=d,o.height=f,o.style.width="",o.style.height="",e.scale(1,1)):(o.width=d*n,o.height=f*l,o.style.width=d+"px",o.style.height=f+"px",e.scale(n,l))}},_resizeCanvases:function(){var e=this,t=e.getSize(),a=t[0],r=t[1],i=G.Browser.getCanvasRatio(),o=(i?i[0]||1:1,i?i[1]||1:1,e.options.canvasExpandFactor),n=a*o,l=r*o;e._canvasOffset=[n,l],e._resizeCanvas(e._onScreenCtx,a,r,i),e._resizeCanvas(e._snapshotCtx,a,r,i),e._resizeCanvas(e._maskCtx,a,r,[1,1]),e._useOffScreen&&e._resizeCanvas(e._offScreenCtx,a,r,i)},_onZoomStart:function(e){this._snapshotCanvas()},_onRotateStart:function(e){this._snapshotCanvas()},_onPinchStart:function(e){this._snapshotCanvas()},_snapshotCanvas:function(){var e=this;if(!e.options.canvasAnimRedraw){var t=e._onScreenCtx.canvas,a=G.Browser.getCanvasRatio(),r=t.width/(a[0]||1),i=t.height/(a[1]||1);e._clearCanvas(e._snapshotCtx),e._snapshotCtx.drawImage(t,0,0,r,i)}},_calcCanvasOffset:function(){var e=this,t=e.getSize(),a=e.getDrawSize(),r=a[0],i=a[1],o=(t[0]-r)/2,n=(t[1]-i)/2;return[o,n]},_beforeMergeFramePos:function(){var e=this,t=e._mapFrame,a=G.DomUtil,r=a.getPosition(t),i=r[0],o=r[1],n=e._spark;if(n){var l=a.getPosition(n)||[0,0];a.markPosTransform(n,l[0]+i,l[1]+o),a.updateTransform(n)}try{e._onScreenCtx.drawImage(e._onScreenCtx.canvas,i,o)}catch(s){}}});